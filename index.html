"use client";

import React, { 
  useMemo, 
  useState, 
  createContext, 
  useContext, 
  ReactNode, 
  SetStateAction, 
  ReactElement, // 'icon' ã®å‹
  HTMLAttributes,
  ButtonHTMLAttributes,
  InputHTMLAttributes,
  TextareaHTMLAttributes,
  Dispatch, // SetStateAction ã®å‹
  JSXElementConstructor, // cloneElement ãŸã‚
  useRef,
  useEffect
} from 'react';

// =================== Icons (å‹å®šç¾©æ¸ˆã¿) ===================
const HomeIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2 7-7 7 7 2 2M5 10v10a1 1 0 001 1h3m10-11v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1"/></svg>);
const BookIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>);
const SparklesIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>);
const ChatIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M8 10h8m-8 4h5M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 7l-4-4H9"/></svg>);
const DashIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M3 3h7v7H3V3zm11 0h7v7h-7V3zM3 14h7v7H3v-7zm11 3h7v4h-7v-4z"/></svg>);
const StarIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.802 2.036a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.802-2.036a1 1 0 00-1.175 0l-2.802 2.036c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.93 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>);
const BellIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/></svg>);
const CheckCircleIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"/></svg>);
const ExclamationCircleIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd"/></svg>);
const FolderIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/></svg>);
const FileIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-4V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clipRule="evenodd"/></svg>);
const ClockIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clipRule="evenodd"/></svg>);
const ChevronRightIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd"/></svg>);
const SendIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009.586 16.5V11a1 1 0 112 0v5.5a1 1 0 00.709.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>);
const InboxIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" /><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" /></svg>);
const UsersIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0117 17h-4.07zM6 12a5 5 0 015 5v0H1a5 5 0 015-5z" /></svg>);
const CalendarIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clipRule="evenodd" /></svg>);
const PersonIcon = (props: React.SVGProps<SVGSVGElement>) => (<svg {...props} viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" /></svg>);


// =================== Primitives (shadcn/ui Dummies) ===================

interface CardProps extends HTMLAttributes<HTMLDivElement> {
  children: ReactNode;
  className?: string;
}
const Card = ({ children, className='', ...props }: CardProps) => (<div className={`border rounded-2xl shadow-sm ${className.includes('bg-') ? '' : 'bg-white'} ${className}`} {...props}>{children}</div>);

interface CardHeaderProps extends HTMLAttributes<HTMLDivElement> {
  children: ReactNode;
  className?: string;
}
const CardHeader = ({ children, className='' }: CardHeaderProps) => (<div className={`p-5 ${className}`}>{children}</div>);

interface CardContentProps extends HTMLAttributes<HTMLDivElement> {
  children: ReactNode;
  className?: string;
}
const CardContent = ({ children, className='' }: CardContentProps) => (<div className={`p-5 pt-0 ${className}`}>{children}</div>);

type ButtonVariant = 'primary' | 'outline' | 'ghost' | 'link';
type ButtonSize = 'md' | 'sm';

interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  children: ReactNode;
  variant?: ButtonVariant;
  size?: ButtonSize;
}

const Button = ({ children, variant='primary', size='md', className='', ...props }: ButtonProps) => {
  const v: Record<ButtonVariant, string> = { primary:'bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-gray-400', outline:'border border-gray-300 hover:bg-gray-50', ghost:'text-gray-700 hover:bg-gray-50', link:'text-indigo-700 hover:underline bg-transparent' };
  const s: Record<ButtonSize, string> = { md:'h-10 px-4 text-sm rounded-lg', sm:'h-8 px-3 text-xs rounded-md' };
  return <button className={`inline-flex items-center justify-center ${v[variant]} ${s[size]} font-medium transition ${className}`} {...props}>{children}</button>;
};

interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  className?: string;
}
const Input = ({ className='', ...props }: InputProps) => (<input className={`w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 ${className}`} {...props}/>);

interface TextareaProps extends TextareaHTMLAttributes<HTMLTextAreaElement> {
  className?: string;
}
const Textarea = ({ className='', ...props }: TextareaProps) => (<textarea className={`w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 ${className}`} {...props}/>);

// =================== Tabs ===================

interface TabsContextType {
  value: string;
  onChange: (value: string) => void;
}
const TabsCtx = createContext<TabsContextType>({ value: '', onChange: () => {} });
const Tabs = ({ value, onChange, children }: { value: string, onChange: (v: string) => void, children: ReactNode }) => (<TabsCtx.Provider value={{ value, onChange }}>{children}</TabsCtx.Provider>);
const TabList = ({ children, className='' }: { children: ReactNode, className?: string }) => (<div className={`flex gap-1 border-b bg-white/80 backdrop-blur px-4 sticky top-16 z-10 ${className}`}>{children}</div>);

// ã€Œã²ã¨ã“ã¨ã€ç”»é¢ç”¨ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’åˆ¥é€”å®šç¾©
interface VoiceTabsContextType {
  value: string;
  onChange: (value: string) => void;
}
const VoiceTabsCtx = createContext<VoiceTabsContextType>({ value: '', onChange: () => {} });
const VoiceTabs = ({ value, onChange, children }: { value: string, onChange: (v: string) => void, children: ReactNode }) => (<VoiceTabsCtx.Provider value={{ value, onChange }}>{children}</VoiceTabsCtx.Provider>);
const VoiceTabList = ({ children, className='' }: { children: ReactNode, className?: string }) => (<div className={`grid grid-cols-3 sm:grid-cols-5 gap-1 sm:gap-2 ${className}`}>{children}</div>);
const VoiceTab = ({ value, children, className='' }: { value: string, children: ReactNode, className?: string }) => { const { value: v, onChange } = useContext(VoiceTabsCtx); const active = v === value; return (<button onClick={()=>onChange(value)} className={`px-2 sm:px-3 py-2 text-xs sm:text-sm font-semibold rounded-lg transition-all truncate ${className}`}>{children}</button>); };
/* â–¼â–¼â–¼ [ä¿®æ­£] w-full ã‚’è¿½åŠ ã—ã€ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã§å¹…ãŒå¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ â–¼â–¼â–¼ */
const VoiceTabPanel = ({ when, children }: { when: string, children: ReactNode }) => { const { value } = useContext(VoiceTabsCtx); return value === when ? <div className="mt-4 w-full">{children}</div> : null; };
const Tab = ({ value, children, className='' }: { value: string, children: ReactNode, className?: string }) => { const { value: v, onChange } = useContext(TabsCtx); const active = v === value; return (<button onClick={()=>onChange(value)} className={`flex items-center justify-center gap-2 px-4 h-12 text-sm border-b-2 -mb-px ${active? 'border-indigo-600 text-indigo-700' : 'border-transparent text-gray-600 hover:text-gray-800'} ${className}`}>{children}</button>); };
/* â–¼â–¼â–¼ [ä¿®æ­£] æ ¹æœ¬çš„ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å•é¡Œã®è§£æ¶ˆã€‚flex-1 ã§é«˜ã•ã‚’ç¢ºä¿ã—ã¤ã¤ã€overflow-auto ã§ä¸­èº«ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ â–¼â–¼â–¼ */
const TabPanel = ({ when, children }: { when: string, children: ReactNode }) => { const { value } = useContext(TabsCtx); return value === when ? <div className="flex-1 flex flex-col min-h-0 p-4 sm:p-6 overflow-auto">{children}</div> : null; };

// =================== Modal ===================
interface ModalProps {
  open: boolean;
  title: string;
  onClose: () => void;
  children: ReactNode;
}
function Modal({ open, title, onClose, children }: ModalProps) { if (!open) return null; return (
  <div className="fixed inset-0 z-50 flex items-center justify-center">
    <div className="absolute inset-0 bg-black/40" onClick={onClose}/>
    <div className="relative bg-white rounded-2xl shadow-2xl w-[92vw] max-w-2xl">
      <div className="flex items-center justify-between p-4 border-b">
        <div className="text-sm font-semibold">{title}</div>
        <button className="text-gray-500 hover:text-gray-700" onClick={onClose}>Ã—</button>
      </div>
      <div className="p-5 text-sm text-gray-800">{children}</div>
    </div>
  </div>
);}

// =================== Dummy Data (Mock) ===================

interface KnowledgeFile {
  id: number;
  type: string;
  title: string;
  uploaded: string;
  size: string;
  important: boolean;
  folderId: string;
}
interface KnowledgeFolder {
  id: string;
  name: string;
  updated: string;
}
interface Notice {
  id: string;
  title: string;
  body: string;
  created: string;
}
interface User {
  id: string;
  name: string;
  avatar: string;
}
interface Member {
  id: string;
  name: string;
}
interface PostReaction {
  emoji: string;
  count: number;
  by: string[];
}
interface Post {
  id: string;
  authorId: string;
  recipient: string | string[]; // â–¼â–¼â–¼ [ä¿®æ­£] å®›å…ˆã‚’ string[] ã‚‚è¨±å®¹
  text: string;
  ts: number;
  reactions: PostReaction[];
  replied?: boolean; // INBOX_POSTS ã«ã®ã¿å­˜åœ¨
}

const KNOWLEDGE: KnowledgeFile[] = [
  { id:1, type:'PDF', title:'2025å¹´å†¬æœŸ æ–°å•†å“ãƒãƒ‹ãƒ¥ã‚¢ãƒ«', uploaded:'2025-10-28', size:'2.5MB', important:true, folderId: 'f1' },
  { id:2, type:'PPTX', title:'ç§‹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å…±æœ‰ä¼š.pptx', uploaded:'2025-10-27', size:'8.2MB', important:true, folderId: 'f1' },
  { id:3, type:'PDF', title:'è¡›ç”Ÿãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ”¹å®šï¼ˆåº—èˆ—ï¼‰', uploaded:'2025-10-25', size:'0.9MB', important:false, folderId: 'f2' },
  { id:4, type:'PDF', title:'VMDé€±æ¬¡ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ_1025.pdf', uploaded:'2025-10-25', size:'5.1MB', important:false, folderId: 'f2' },
  { id:5, type:'PDF', title:'æ–°äººç ”ä¿®ã‚¬ã‚¤ãƒ‰v3', uploaded:'2025-10-22', size:'1.2MB', important:false, folderId: 'f3' },
  { id:6, type:'PDF', title:'ä¾¡æ ¼æ”¹å®šãƒãƒªã‚·ãƒ¼ï¼ˆç¢ºå®šï¼‰', uploaded:'2025-10-19', size:'0.6MB', important:true, folderId: 'f2' },
];
const KNOWLEDGE_FOLDERS: KnowledgeFolder[] = [
  { id: 'f1', name: 'æ–°å•†å“ãƒ»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³è³‡æ–™', updated: '2025-10-28' },
  { id: 'f2', name: 'åº—èˆ—é‹å–¶ãƒãƒ‹ãƒ¥ã‚¢ãƒ«', updated: '2025-10-25' },
  { id: 'f3', name: 'ç ”ä¿®ãƒ»ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°', updated: '2025-10-22' },
];
const INITIAL_NOTICES: Notice[] = [ { id:'n1', title:'ä»Šé€±ã®é‡ç‚¹æ¥å®¢ãƒã‚¤ãƒ³ãƒˆ', body:'ãƒ†ã‚¹ã‚¿ãƒ¼å£°ã‹ã‘ã¯ã€ŒãŠè‚Œæ‚©ã¿â†’ææ¡ˆâ†’æ‹­ãå–ã‚Šã€ã€‚å„è‡ª3å›ã¯å£°æ›ã‘ã€‚', created:'2025-10-29 09:00' } ];

const USER: User = { id: 'you', name: 'ç”°ä¸­ï¼ˆåº—é•·ï¼‰', avatar: 'https://placehold.co/40x40/B0B0B0/FFFFFF?text=åº—é•·' };

const MEMBERS: Member[] = [ 
  { id:'you', name:'ç”°ä¸­ï¼ˆåº—é•·ï¼‰' }, // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆåº—é•·ï¼‰
  { id:'sato', name:'ä½è—¤' }, 
  { id:'suzuki', name:'éˆ´æœ¨' }, 
  { id:'yamaguchi', name:'å±±å£' }, 
  { id:'kimura', name:'æœ¨æ‘' }, 
  /* â–¼â–¼â–¼ [ä¿®æ­£] "å…¨å“¡ä½“ï¼ˆæ²ç¤ºæ¿ï¼‰" ã‚’ "å…¨å“¡" ã«ä¿®æ­£ â–¼â–¼â–¼ */
  { id:'zen', name:'å…¨å“¡' } 
];
const NAME_MAP = new Map(MEMBERS.map(m=>[m.id,m.name]));
const GET_NAME = (id: string)=> NAME_MAP.get(id)||id;

const MY_POSTS: Post[] = [
  { id:'m1', authorId:'you', recipient:'sato', text:'VMDæ£šæ›¿ãˆã®å¯¾å¿œã‚ã‚ŠãŒã¨ã†ï¼ã™ã”ãè‰¯ããªã£ãŸã€‚', ts: Date.parse('2025-10-28T11:00:00+09:00'), reactions: [{emoji: 'ğŸ‘', count: 1, by: ['sato']}] },
  { id:'m2', authorId:'you', recipient:'zen', text:'æœˆåˆãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ã‚¢ã‚¸ã‚§ãƒ³ãƒ€å…±æœ‰', ts: Date.parse('2025-10-27T19:00:00+09:00'), reactions: [] },
  { id:'m3', authorId:'you', recipient:'suzuki', text:'æ˜¨æ—¥ã®ãƒ•ã‚©ãƒ­ãƒ¼åŠ©ã‹ã£ãŸã€ã‚ã‚ŠãŒã¨ã†ï¼', ts: Date.parse('2025-10-29T11:10:00+09:00'), reactions: [{emoji: 'ğŸ˜Š', count: 1, by: ['suzuki']}]},
  { id:'m4', authorId:'you', recipient:'kimura', text:'ã‚·ãƒ•ãƒˆã®ä»¶ã€ç¢ºèªã—ã¾ã—ãŸã€‚', ts: Date.parse('2025-10-26T18:00:00+09:00'), reactions: [] },
];
const INBOX_POSTS: Post[] = [
  { id:'i1', authorId:'suzuki', recipient:'you', text:'æ¥å®¢ã‚µãƒãƒ¼ãƒˆåŠ©ã‹ã‚Šã¾ã—ãŸï¼', ts: Date.parse('2025-10-27T09:00:00+09:00'), replied: true, reactions: [{emoji: 'ğŸ‘', count: 1, by: ['you']}] },
  { id:'i2', authorId:'sato', recipient:'you', text:'ã‚®ãƒ•ãƒˆåŒ…è£…ã®ä»¶ã€ç¢ºèªãŠé¡˜ã„ã—ã¾ã™', ts: Date.parse('2025-10-28T19:20:00+09:00'), replied:false, reactions: [] },
  { id:'i3', authorId:'kimura', recipient:'you', text:'ã‚·ãƒ•ãƒˆä»£è¡Œæ„Ÿè¬ã§ã™ã€‚', ts: Date.parse('2025-10-26T18:15:00+09:00'), replied: true, reactions: [] },
  { id:'i4', authorId:'yamaguchi', recipient:'you', text:'æ˜æ—¥ã®å…¥ã‚Šæ™‚é–“å¤§ä¸ˆå¤«ãã†ã§ã™ã‹ï¼Ÿ', ts: Date.parse('2025-10-27T14:00:00+09:00'), replied:false, reactions: [] },
];
const ALL_PUBLIC_POSTS: Post[] = [
  { id:'e1', authorId:'sato', recipient:'zen', text:'ãƒ†ã‚¹ã‚¿ãƒ¼è£œå……å°ç·šã‚’æ”¹å–„ã—ã¾ã—ãŸ', ts: Date.parse('2025-10-29T12:00:00+09:00'), reactions: [{emoji: 'ğŸ’¡', count: 2, by: ['you', 'kimura']}] },
  { id:'e2', authorId:'suzuki', recipient:'sato', text:'VMDæ£šæ›¿ãˆã®å¯¾å¿œã‚ã‚ŠãŒã¨ã†ï¼', ts: Date.parse('2025-10-28T10:30:00+09:00'), reactions: [{emoji: 'ğŸ˜Š', count: 1, by: ['sato']}] },
  { id:'e3', authorId:'kimura', recipient:'yamaguchi', text:'ã‚¹ãƒˆãƒƒã‚¯æ•´ç†ã®ä»¶ã€äº†è§£ã§ã™ã€‚', ts: Date.parse('2025-10-27T20:00:00+09:00'), reactions: [] },
  { id:'e4', authorId:'sato', recipient:'suzuki', text:'ãƒ•ã‚©ãƒ­ãƒ¼ã‚ã‚ŠãŒã¨ã†ï¼', ts: Date.parse('2025-10-29T11:15:00+09:00'), reactions: [{emoji: 'ğŸ‘', count: 1, by: ['suzuki']}] },
];

const FMT = new Intl.DateTimeFormat("ja-JP",{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false,timeZone:'Asia/Tokyo'});
const FORMAT_TS = (ts: number | Date)=> FMT.format(new Date(ts));


// =================== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ ===================

// --- ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ (æ—¥ä»˜string: [ãƒ¡ãƒ³ãƒãƒ¼ID, æ™‚é–“string]) ---
type ShiftData = Record<string, { m: string; t: string }[]>;
const SHIFTS: ShiftData = {
  "2025-11-03": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-15:00' }, { m: 'suzuki', t: 'ä¼‘ã¿' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-04": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: 'ä¼‘ã¿' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-05": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: 'ä¼‘ã¿' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-06": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: 'ä¼‘ã¿' } ],
  "2025-11-07": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: 'ä¼‘ã¿' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-08": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-09": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-10": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-15:00' }, { m: 'suzuki', t: 'ä¼‘ã¿' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-11": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: 'ä¼‘ã¿' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-12": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: 'ä¼‘ã¿' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-13": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: 'ä¼‘ã¿' } ],
  "2025-11-14": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: 'ä¼‘ã¿' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-15": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-16": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-17": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-15:00' }, { m: 'suzuki', t: 'ä¼‘ã¿' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-18": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: 'ä¼‘ã¿' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-19": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: 'ä¼‘ã¿' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-20": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: 'ä¼‘ã¿' } ],
  "2025-11-21": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: 'ä¼‘ã¿' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-22": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-23": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-24": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-15:00' }, { m: 'suzuki', t: 'ä¼‘ã¿' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-25": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: 'ä¼‘ã¿' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-26": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: 'ä¼‘ã¿' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-27": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: 'ä¼‘ã¿' } ],
  "2025-11-28": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: 'ä¼‘ã¿' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-29": [ { m: 'you', t: '9:00-18:00' }, { m: 'sato', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' }, { m: 'kimura', t: '12:00-21:00' } ],
  "2025-11-30": [ { m: 'you', t: '9:00-18:00' }, { m: 'suzuki', t: '9:00-18:00' }, { m: 'yamaguchi', t: '11:00-20:00' } ],
};

// --- çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ ---
interface AllDayEvent {
  id: string;
  title: string;
  start: string; // YYYY-MM-DD
  end: string;   // YYYY-MM-DD
  color: string;
}
const ALL_DAY_EVENTS: AllDayEvent[] = [
  { id: 'e1', title: 'æ–°å•†å“A ç™ºå£²æ—¥', start: '2025-11-05', end: '2025-11-05', color: 'bg-green-100 text-green-800' },
  { id: 'e2', title: 'é€±æœ«Wãƒã‚¤ãƒ³ãƒˆCP', start: '2025-11-07', end: '2025-11-09', color: 'bg-indigo-100 text-indigo-800' },
  { id: 'e3', title: 'é€±æœ«Wãƒã‚¤ãƒ³ãƒˆCP', start: '2025-11-14', end: '2025-11-16', color: 'bg-indigo-100 text-indigo-800' },
  { id: 'e4', title: 'BLACK FRIDAY ã‚»ãƒ¼ãƒ«', start: '2025-11-28', end: '2025-11-30', color: 'bg-gray-800 text-white' },
];

// --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å®šæ•° ---
const GRID_START_HOUR = 8;
const GRID_END_HOUR = 22;
const timeSlots = Array.from({ length: (GRID_END_HOUR - GRID_START_HOUR) }, (_, i) => GRID_START_HOUR + i);

// --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼Utility ---
const getMemberColor = (memberId: string) => {
  const colors = [
    'bg-blue-100 border-blue-300 text-blue-800', 
    'bg-purple-100 border-purple-300 text-purple-800',
    'bg-pink-100 border-pink-300 text-pink-800',
    'bg-amber-100 border-amber-300 text-amber-800',
    'bg-teal-100 border-teal-300 text-teal-800',
    'bg-gray-100 border-gray-300 text-gray-800'
  ];
  const index = MEMBERS.findIndex(m => m.id === memberId);
  return colors[index % colors.length] || colors[5];
};

// YYYY-MM-DD å½¢å¼ã®æ–‡å­—åˆ—ã‚’è¿”ã™
// â–¼â–¼â–¼ [ä¿®æ­£] JSTåŸºæº–ã§æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ (toISOStringä¾å­˜ã‚’å‰Šé™¤) â–¼â–¼â–¼
const toDateString = (date: Date): string => {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
};

// é€±ã®é–‹å§‹æ—¥ï¼ˆæœˆæ›œæ—¥ï¼‰ã‚’å–å¾—
const getWeekStart = (date: Date) => {
  const d = new Date(date);
  d.setHours(0, 0, 0, 0); // JSTã®0æ™‚0åˆ†0ç§’ã«ãƒªã‚»ãƒƒãƒˆ
  const day = d.getDay(); // 0 (Sun) - 6 (Sat)
  const diff = d.getDate() - day + (day === 0 ? -6 : 1); // day=0(Sun)ãªã‚‰-6ã€day=1(Mon)ãªã‚‰+0
  return new Date(d.setDate(diff));
};

// "9:00-18:00" -> { startHour: 9.0, endHour: 18.0 }
const parseShiftTime = (time: string) => {
  if (time === 'ä¼‘ã¿') {
    return { startHour: null, endHour: null, isOff: true };
  }
  const parts = time.split('-');
  if (parts.length !== 2) {
    return { startHour: null, endHour: null, isOff: false }; // ä¸æ˜ãªå½¢å¼
  }
  const [startStr, endStr] = parts;
  const startHour = parseInt(startStr.split(':')[0], 10) + parseInt(startStr.split(':')[1] || '0', 10) / 60;
  const endHour = parseInt(endStr.split(':')[0], 10) + parseInt(endStr.split(':')[1] || '0', 10) / 60;
  return { startHour, endHour, isOff: false };
};

// â–¼â–¼â–¼ [ä¿®æ­£] ã“ã®é–¢æ•°ã¯ä½¿ç”¨ã•ã‚Œãªããªã‚Šã¾ã—ãŸãŒã€VoiceTrustV8Style ã®ãŸã‚ã«æ®‹ã—ã¦ãŠãã¾ã™ â–¼â–¼â–¼
const getShiftForMember = (date: Date, memberId: string) => {
  const dateStr = toDateString(date);
  const shifts = SHIFTS[dateStr as keyof ShiftData] || [];
  const shift = shifts.find(s => s.m === memberId);
  const time = shift ? shift.t : 'ä¼‘ã¿'; // ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ä¼‘ã¿
 
  const { startHour, endHour, isOff } = parseShiftTime(time);
 
  return {
    memberId,
    name: GET_NAME(memberId),
    time,
    startHour,
    endHour,
    isOff,
  };
};

// 2ã¤ã®æ—¥ä»˜ãŒåŒã˜æ—¥ã‹
const isSameDay = (d1: Date, d2: Date) => {
  return d1.getFullYear() === d2.getFullYear() &&
         d1.getMonth() === d2.getMonth() &&
         d1.getDate() === d2.getDate();
};

// =================== Root ===================
export default function TsumugiApp(){
  const [role, setRole] = useState('manager'); // 'staff' | 'manager'
  const [tab, setTab] = useState('home');
  const [menuOpen, setMenuOpen] = useState(false);

  const tabs: [string, string, ReactElement<React.SVGProps<SVGSVGElement>>][] = role==='manager'
    ? [['home','ãƒ›ãƒ¼ãƒ ',<HomeIcon/>], ['calendar', 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', <CalendarIcon/>], ['dashboard','ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',<DashIcon/>],['voice','ã²ã¨ã“ã¨',<ChatIcon/>],['knowledge','ãƒŠãƒ¬ãƒƒã‚¸',<BookIcon/>],['integrations','é€£æº',<SparklesIcon/>]]
    : [['home','ãƒ›ãƒ¼ãƒ ',<HomeIcon/>], ['calendar', 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', <CalendarIcon/>], ['voice','ã²ã¨ã“ã¨',<ChatIcon/>],['knowledge','ãƒŠãƒ¬ãƒƒã‚¸',<BookIcon/>]];

  const headerClass = role === 'manager'
    ? "bg-gray-800 text-white" // ç®¡ç†è€…ç”¨ã®è‰²
    : "bg-gradient-to-r from-indigo-600 to-purple-600 text-white"; // ã‚¹ã‚¿ãƒƒãƒ•ç”¨ã®è‰²

  return (
    /* â–¼â–¼â–¼ [æ ¹æœ¬ä¿®æ­£] min-h-screen ã‚’ h-screen overflow-hidden ã«å¤‰æ›´ â–¼â–¼â–¼ */
    /* ã“ã‚Œã«ã‚ˆã‚Šãƒšãƒ¼ã‚¸å…¨ä½“ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªããªã‚Šã€å†…éƒ¨ã® sticky ã¨ flex-1 ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ */
    <div className="h-screen overflow-hidden flex flex-col bg-gray-50">
      <div className={`h-16 flex items-center justify-between px-4 sticky top-0 z-20 shadow-md ${headerClass}`}>
        <div className="flex items-center gap-3">
          <SparklesIcon className="w-8 h-8 opacity-90"/>
          <div className="leading-tight">
            <div className="text-lg font-extrabold tracking-tight">tsumugi</div>
            <div className={`text-xs ${role === 'manager' ? 'text-gray-300' : 'text-indigo-100'} -mt-0.5`}>
              {role === 'manager' ? 'ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ–°å®¿åº—ï¼‰' : 'æ–°å®¿åº—'}
            </div>
          </div>
        </div>
       
        <div className="flex items-center gap-2">
          <button className="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/10 relative">
            <BellIcon className="w-5 h-5"/>
            <span className="absolute top-2 right-2 w-2.5 h-2.5 bg-rose-500 rounded-full border-2 border-white"/>
          </button>
         
          <div className="relative">
            <button onClick={() => setMenuOpen(prev => !prev)} className="flex items-center gap-2 rounded-full border border-white/30 px-1.5 py-1.5 text-sm hover:bg-white/10">
              <img className="w-7 h-7 rounded-full bg-gray-300" src={USER.avatar} alt={USER.name} />
              <span className="font-medium pr-2 hidden sm:block">{USER.name}</span>
            </button>
           
            <div className={`absolute right-0 mt-1 bg-white border rounded-xl shadow-lg w-48 p-2 text-gray-900 ${menuOpen ? 'block' : 'hidden'}`}>
              <div className="p-2 text-xs text-gray-500">ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</div>
            <div className="p-2 text-sm font-medium">{GET_NAME('suzuki')}</div>
            <div className="p-2 text-sm font-medium">{GET_NAME('sato')}</div>
              <div className="h-px bg-gray-100 my-1"></div>
              <button onClick={()=>{ setRole(r=>r==='manager'?'staff':'manager'); setMenuOpen(false); setTab('home'); }} className="w-full text-left p-2 text-sm rounded-lg hover:bg-gray-100">
                {role==='manager'?'ã‚¹ã‚¿ãƒƒãƒ•è¡¨ç¤ºã«åˆ‡æ›¿':'ç®¡ç†è¡¨ç¤ºã«åˆ‡æ›¿'}
              </button>
              <button onClick={() => setMenuOpen(false)} className="w-full text-left p-2 text-sm rounded-lg hover:bg-gray-100">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
          </div>
        </div>
      </div>

      <Tabs value={tab} onChange={setTab}>
        <TabList className={`bg-white border-b shadow-sm px-1 sm:px-4 ${role === 'manager' ? 'border-gray-300' : 'border-indigo-100'}`}>
          {tabs.map(([id,label,icon])=> {
            const activeClass = role === 'manager' 
              ? 'border-gray-700 text-gray-800' 
              : 'border-indigo-600 text-indigo-700';
            const inactiveClass = 'border-transparent text-gray-600 hover:text-gray-800';
           
            return (
              <Tab key={id} value={id} className={`flex-1 sm:flex-initial ${tab === id ? activeClass : inactiveClass}`}>
                <span className="flex items-center gap-1.5">
                  {React.cloneElement(icon, { className: 'w-5 h-5' })}
                  <span className="hidden sm:inline">{label}</span>
                </span>
              </Tab>
            )
          })}
        </TabList>
        <TabPanel when="home"><HomeDashboard role={role}/></TabPanel>
        <TabPanel when="calendar"><CalendarView /></TabPanel> 
        <TabPanel when="voice"><VoiceTrustV8Style role={role} /></TabPanel> 
        <TabPanel when="knowledge"><KnowledgeBase role={role}/></TabPanel>
        {role==='manager' && <TabPanel when="dashboard"><RelationshipDashboard/></TabPanel>}
        {role==='manager' && <TabPanel when="integrations"><Integrations/></TabPanel>}
      </Tabs>
    </div>
  );
}

// =================== Home (ã€Œé–‹ããŸããªã‚‹ã€UI) ===================
interface HomeDashboardProps {
  role: string;
}
interface UnreadTask {
  id: string;
  type: string;
  title: string;
  due: string;
  from: string;
}
interface Thank {
  id: string;
  from: string;
  to: string;
  text: string;
}

function HomeDashboard({ role }: HomeDashboardProps){
  const [noticeOpen, setNoticeOpen] = useState(false);
  const [noticeTarget, setNoticeTarget] = useState<Notice | null>(null);
  const [notices] = useState<Notice[]>(INITIAL_NOTICES);

  const unreadTasks: UnreadTask[] = [
    { id: 't1', type: 'knowledge', title: 'ç§‹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å…±æœ‰ä¼š.pptx', due: 'æœ¬æ—¥ä¸­', from: 'æœ¬éƒ¨' },
    { id: 't2', type: 'notice', title: 'ä»Šé€±ã®é‡ç‚¹æ¥å®¢ãƒã‚¤ãƒ³ãƒˆ', due: 'æœ¬æ—¥ä¸­', from: GET_NAME('you') }, // 'tencho' -> 'you' ã«ä¿®æ­£
  ];
 
  const thanks: Thank[] = [
    { id: 'th1', from: 'sato', to: 'yamaguchi', text: 'æ˜¨æ—¥ã®ãƒ¬ã‚¸ç· ã‚ä»£è¡Œã€æ„Ÿè¬ã§ã™ï¼' },
    { id: 'th2', from: 'you', to: 'kimura', text: 'VMDå¤‰æ›´ã€ã™ã”ãè‰¯ããªã£ãŸï¼' },
    { id: 'th3', from: 'sato', to: 'you', text: 'ãƒ•ã‚©ãƒ­ãƒ¼ã‚ã‚ŠãŒã¨ã†ï¼' }, 
  ];

  const openNotice = (n: Notice) => {
    setNoticeTarget(n);
    setNoticeOpen(true);
  };

  return (
    <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
     
      {/* --- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ  (2/3) --- */}
      <div className="lg:col-span-2 space-y-6">
       
        {/* 1. ã‚ãªãŸå®›ã¦ã®ã‚¿ã‚¹ã‚¯ */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div className="font-semibold text-lg text-gray-900">ã‚ãªãŸå®›ã¦ã®ç¢ºèªäº‹é …ï¼ˆ{unreadTasks.length}ä»¶ï¼‰</div>
            </div>
          </CardHeader>
          <CardContent className="space-y-3">
            {unreadTasks.map(task => (
              <div key={task.id} className="flex items-center gap-3 p-3 border rounded-xl hover:bg-gray-50 cursor-pointer">
                <div className="w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center">
                  {task.type === 'knowledge' ? <BookIcon className="w-5 h-5"/> : <ExclamationCircleIcon className="w-5 h-5"/>}
                </div>
                <div className="flex-1">
                  <div className="font-medium text-sm">{task.title}</div>
                  <div className="text-xs text-gray-500">From: {task.from} / æœŸé™: {task.due}</div>
                </div>
                <Button variant="outline" size="sm">ä»Šã™ãç¢ºèª</Button>
              </div>
            ))}
          </CardContent>
        </Card>

        {/* 2. å¿…é ˆãƒŠãƒ¬ãƒƒã‚¸ï¼ˆAIè¦ç´„ï¼‰ */}
        <Card>
          <CardHeader>
            <div className="font-semibold text-lg text-gray-900">ä»Šæ—¥ã®å¿…é ˆãƒŠãƒ¬ãƒƒã‚¸ï¼ˆAIè¦ç´„ï¼‰</div>
          </CardHeader>
          <CardContent>
            <div className="p-4 bg-purple-50 rounded-xl border border-purple-200">
              <div className="flex items-center gap-2 mb-2">
                <span className="text-purple-600"><StarIcon className="w-5 h-5"/></span>
                <div className="font-semibold text-purple-800">2025å¹´å†¬æœŸ æ–°å•†å“ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</div>
              </div>
              <div className="text-sm text-gray-700 space-y-1">
                <p>1. <span className="font-bold">é‡è¦ãƒã‚¤ãƒ³ãƒˆ:</span> æ–°ä¿æ¹¿æˆåˆ†ã€Œãƒªãƒ”ã‚¸ãƒ¥ã‚¢EXã€é…åˆãŒæœ€å¤§ã®å£²ã‚Šã§ã™ã€‚</p>
                <p>2. <span className="font-bold">ç¾å ´ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</span> æ•æ„Ÿè‚Œã®ãŠå®¢æ§˜ã«ã¯ã€ã¾ãšãƒ†ã‚¹ã‚¿ãƒ¼ã§ã®å£°ã‹ã‘ã‚’å¾¹åº•ã—ã¦ãã ã•ã„ã€‚</p>
                <p>3. <span className="font-bold">æ³¨æ„äº‹é …:</span> æ—¢å­˜ã®ã€Œãƒ¢ã‚¤ã‚¹ãƒˆãƒ­ãƒ¼ã‚·ãƒ§ãƒ³ã€ã¨ã¯ä½µç”¨ã›ãšã€åˆ‡ã‚Šæ›¿ãˆã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>
              </div>
              <Button size="sm" className="mt-3">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</Button>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* --- ã‚µã‚¤ãƒ‰ã‚«ãƒ©ãƒ  (1/3) --- */}
      <div className="space-y-6">
        {/* 3. ç§°è³›ï¼ˆã‚ã‚ŠãŒã¨ã†ï¼‰ */}
        <Card>
          <CardHeader>
            <div className="font-semibold text-lg text-rose-700">æœ€è¿‘ã®ã€Œã‚ã‚ŠãŒã¨ã†ã€ğŸ‘</div>
          </CardHeader>
          <CardContent className="space-y-3">
            {thanks.map(t => (
              <div key={t.id} className="p-3 bg-rose-50 rounded-lg">
                <div className="flex items-center gap-2 text-xs text-rose-600 font-medium mb-1">
                  <span>{GET_NAME(t.from)}</span>
                  <span>â†’</span>
                  <span>{GET_NAME(t.to)}</span>
                </div>
                <p className="text-sm text-gray-800">ã€Œ{t.text}ã€</p>
              </div>
            ))}
            <Button variant="outline" className="w-full">ã‚ã‚ŠãŒã¨ã†ã‚’è´ˆã‚‹</Button>
          </CardContent>
        </Card>

        {/* 4. åº—é•·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
        <Card>
          <CardHeader>
            <div className="font-semibold text-lg text-gray-900">åº—é•·ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</div>
          </CardHeader>
          <CardContent className="space-y-3">
            {notices.map(n => (
              <div key={n.id} className="p-3 border rounded-xl bg-white hover:bg-gray-50 cursor-pointer" onClick={() => openNotice(n)}>
                <div className="text-sm font-semibold text-gray-800">{n.title}</div>
                <div className="text-xs text-gray-500">{n.created}</div>
              </div>
            ))}
          </CardContent>
        </Card>
      </div>
     
      <Modal open={noticeOpen} title={noticeTarget ? noticeTarget.title : ''} onClose={()=>setNoticeOpen(false)}>
        <div className="whitespace-pre-line text-sm">{noticeTarget ? noticeTarget.body : ''}</div>
      </Modal>
    </div>
  );
}


// =================== CalendarView (GCalé¢¨ UI) ===================

// --- Main Component ---
function CalendarView() {
  const [viewMode, setViewMode] = useState<'month' | 'week' | 'day'>('week');
  const [currentDate, setCurrentDate] = useState(new Date('2025-11-03T12:00:00+09:00')); // 11/3 (æœˆ) ã‚’åŸºæº–
  const today = useMemo(() => new Date('2025-11-03T12:00:00+09:00'), []); // å›ºå®šã®ä»Šæ—¥

  const goToPrev = () => {
    setCurrentDate(prev => {
      const d = new Date(prev);
      if (viewMode === 'month') d.setMonth(d.getMonth() - 1);
      if (viewMode === 'week') d.setDate(d.getDate() - 7);
      if (viewMode === 'day') d.setDate(d.getDate() - 1);
      return d;
    });
  };

  const goToNext = () => {
    setCurrentDate(prev => {
      const d = new Date(prev);
      if (viewMode === 'month') d.setMonth(d.getMonth() + 1);
      if (viewMode === 'week') d.setDate(d.getDate() + 7);
      if (viewMode === 'day') d.setDate(d.getDate() + 1);
      return d;
    });
  };

  const goToToday = () => {
    setCurrentDate(today);
  };
 
  const getHeaderDateRange = () => {
    const d = new Date(currentDate);
    if (viewMode === 'month') {
      return `${d.getFullYear()}å¹´ ${d.getMonth() + 1}æœˆ`;
    }
    if (viewMode === 'week') {
      const start = getWeekStart(d);
      const end = new Date(start);
      end.setDate(end.getDate() + 6);
      const y = start.getFullYear();
      const m1 = start.getMonth() + 1;
      const d1 = start.getDate();
      const m2 = end.getMonth() + 1;
      const d2 = end.getDate();
      if (m1 === m2) return `${y}å¹´ ${m1}æœˆ${d1}æ—¥-${d2}æ—¥`;
      return `${y}å¹´ ${m1}æœˆ${d1}æ—¥-${m2}æœˆ${d2}æ—¥`;
    }
    if (viewMode === 'day') {
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      const day = d.getDate();
      const w = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][d.getDay()];
      return `${y}å¹´ ${m}æœˆ${day}æ—¥ (${w})`;
    }
  };
 
  const ViewButton = ({ value, label }: { value: 'month' | 'week' | 'day', label: string }) => {
    const isActive = viewMode === value;
    return (
      <button 
        onClick={() => setViewMode(value)} 
        className={`px-3 py-1.5 text-xs font-semibold rounded-md ${isActive ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100 border'}`}
      >
        {label}
      </button>
    );
  };

  return (
    <div className="flex flex-col h-full min-h-[70vh]"> {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¨ä½“ãŒé«˜ã•ã‚’ç¢ºä¿ã™ã‚‹ã‚ˆã†ã« */}
      <Card className="flex flex-col flex-1 min-h-0"> {/* ã‚«ãƒ¼ãƒ‰ã‚‚è¿½å¾“ */}
        {/* --- Header --- */}
        <CardHeader className="pb-0">
          <div className="flex items-center justify-between flex-wrap gap-2">
            <div className="flex items-center gap-2">
              <Button variant="outline" size="sm" onClick={goToToday}>ä»Šæ—¥</Button>
              <button onClick={goToPrev} className="p-1 rounded-md hover:bg-gray-100 text-gray-600">
                <ChevronRightIcon className="w-6 h-6 transform rotate-180" />
              </button>
              <button onClick={goToNext} className="p-1 rounded-md hover:bg-gray-100 text-gray-600">
                <ChevronRightIcon className="w-6 h-6" />
              </button>
              <div className="text-xl font-semibold text-gray-800 ml-2">{getHeaderDateRange()}</div>
            </div>
            <div className="flex items-center gap-1 rounded-lg p-0.5">
              <ViewButton value="month" label="æœˆ" />
              <ViewButton value="week" label="é€±" />
              <ViewButton value="day" label="æ—¥" />
            </div>
          </div>
        </CardHeader>
       
        {/* --- Content --- */}
        {/* flex-1 min-h-0 ã§ä¸­èº«ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */}
        <CardContent className="pt-2 flex-1 min-h-0 flex flex-col"> 
          {viewMode === 'month' && <MonthView currentDate={currentDate} today={today} />}
          {viewMode === 'week' && <WeekViewGcal currentDate={currentDate} today={today} />}
          {viewMode === 'day' && <DayViewGcal currentDate={currentDate} today={today} />}
        </CardContent>
      </Card>
    </div>
  );
}

// --- WeekViewGcal (Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¢¨ã‚¿ã‚¤ãƒ ã‚°ãƒªãƒƒãƒ‰ãƒ»é€±) ---
function WeekViewGcal({ currentDate, today }: { currentDate: Date, today: Date }) {
  const weekStart = getWeekStart(currentDate);
  const todayStr = toDateString(today);
  const weekDays = Array.from({ length: 7 }).map((_, i) => {
    const d = new Date(weekStart);
    d.setDate(d.getDate() + i);
    return d;
  });
  const dayNames = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];

  // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã®è¨ˆç®—
  const weekEvents = ALL_DAY_EVENTS.filter(e => {
    const start = new Date(e.start + 'T00:00:00+09:00');
    const end = new Date(e.end + 'T00:00:00+09:00');
    const weekEnd = new Date(weekDays[6]);
    weekEnd.setHours(23, 59, 59); // é€±ã®çµ‚ã‚ã‚Š
    return start <= weekEnd && end >= weekDays[0];
  });
 
  // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã®è¡Œå‰²ã‚Šå½“ã¦ (ç°¡æ˜“)
  let maxAllDayRows = 0;
  const allDayEventsWithRow = weekEvents.map(event => {
    const start = new Date(event.start + 'T00:00:00+09:00');
    const end = new Date(event.end + 'T00:00:00+09:00');
   
    let colStart = weekDays.findIndex(day => isSameDay(day, start));
    if (colStart === -1 && start < weekDays[0]) colStart = 0; // é€±ã‚’ã¾ãŸã„ã§é–‹å§‹
   
    let colEnd = weekDays.findIndex(day => isSameDay(day, end));
    if (colEnd === -1 && end > weekDays[6]) colEnd = 6; // é€±ã‚’ã¾ãŸã„ã§çµ‚äº†
   
    if (colStart === -1 || colEnd === -1) return null; // ç¯„å›²å¤–
   
    const duration = colEnd - colStart + 1;
    // TODO: æœ¬æ¥ã¯è¡Œã®é‡ãªã‚Šã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
    const row = 1; 
    maxAllDayRows = Math.max(maxAllDayRows, row);
   
    return { ...event, colStart, duration, row };
  }).filter(Boolean) as (AllDayEvent & { colStart: number, duration: number, row: number })[];
 
  const allDayRowHeight = Math.max(1, maxAllDayRows) * 32 + 8; // 1è¡Œ32px + padding

  return (
    <div className="h-full overflow-auto relative" style={{ minWidth: '800px' }}>
      <div 
        className="grid relative" 
        style={{
          gridTemplateColumns: '60px repeat(7, 1fr)', // Time Axis + 7 Days
          gridTemplateRows: `auto auto repeat(${timeSlots.length}, 60px) auto` // Header + AllDay + Slots + Footer(dummy)
        }}
      >
        {/* --- Row 1: Date Header --- */}
        <div className="sticky top-0 z-20 bg-white border-b border-r" style={{ gridColumn: 1, gridRow: 1 }}>&nbsp;</div>
        {weekDays.map((day, i) => (
          <div 
            key={i} 
            className={`sticky top-0 z-20 bg-white border-b p-2 text-center ${i < 6 ? 'border-r' : ''} ${isSameDay(day, today) ? 'bg-indigo-50' : ''}`}
            style={{ gridColumn: i + 2, gridRow: 1 }}
          >
            <div className="text-xs text-gray-500">{dayNames[i]}</div>
            <div className={`text-2xl font-medium ${isSameDay(day, today) ? 'text-indigo-700' : 'text-gray-800'}`}>
              {day.getDate()}
            </div>
          </div>
        ))}
       
        {/* --- Row 2: All-Day --- */}
        <div className="sticky top-[73px] z-20 bg-white border-b border-r text-right pr-2 pt-1 text-xs text-gray-400" style={{ gridColumn: 1, gridRow: 2, height: `${allDayRowHeight}px` }}>çµ‚æ—¥</div>
        <div 
          className="sticky top-[73px] z-20 bg-white col-span-7 border-b p-1 grid"
          style={{ 
            gridColumn: '2 / -1',
            gridRow: 2,
            height: `${allDayRowHeight}px`,
            gridTemplateColumns: 'repeat(7, 1fr)',
          }}
        >
          {allDayEventsWithRow.map(event => (
            <div 
              key={event.id}
              className={`h-6 px-2 py-0.5 rounded text-xs font-medium overflow-hidden ${event.color} mx-0.5`}
              style={{
                gridColumn: `${event.colStart + 1} / span ${event.duration}`, // +1 (0-indexed -> 1-indexed)
                top: `${(event.row - 1) * 28 + 4}px`,
              }}
            >
              {event.title}
            </div>
          ))}
        </div>
       
        {/* --- Rows 3+: Time Grid --- */}
        {/* Time Axis (A3-A15) */}
        {timeSlots.map((hour, hourIndex) => (
            <React.Fragment key={hour}>
            {/* Time Label */}
            <div className="relative text-right pr-2 border-r -mt-2.5" style={{gridColumn: 1, gridRow: hourIndex + 3}}>
                <span className="text-xs text-gray-400 sticky left-0">{hour}:00</span>
              </div>
            {/* Grid Cells (Empty) */}
            {Array.from({ length: 7 }).map((_, dayIndex) => (
                <div 
                  key={dayIndex} 
                  className={`border-b ${dayIndex < 6 ? 'border-r' : ''}`}
                  style={{ gridColumn: dayIndex + 2, gridRow: hourIndex + 3 }}
                >
                  &nbsp;
                </div>
            ))}
            </React.Fragment>
        ))}
       
        {/* --- Shift Events (Overlay) --- */}
        <div 
          className="relative"
          style={{
            gridColumn: '2 / -1',
            gridRow: `3 / span ${timeSlots.length}`,
            pointerEvents: 'none' 
          }}
        >
          {weekDays.map((day, dayIndex) => {
            const dateStr = toDateString(day); // <-- ã“ã“ã®`toDateString`ãŒä¿®æ­£ã•ã‚ŒãŸ
            const shifts = (SHIFTS[dateStr as keyof ShiftData] || [])
              .map(s => {
                const { startHour, endHour, isOff } = parseShiftTime(s.t);
                return {
                  memberId: s.m,
                  time: s.t,
                  startHour,
                  endHour,
                  isOff,
                };
              })
              .filter(s => !s.isOff && s.startHour && s.endHour);
             
            // é‡ãªã‚Šè¨ˆç®— (ç°¡æ˜“ç‰ˆ)
            const shiftsWithOffset = shifts.map(s => ({ ...s, offset: 0, overlap: 1 }));
            for (let i = 0; i < shiftsWithOffset.length; i++) {
                let overlaps = [];
                for (let j = 0; j < shiftsWithOffset.length; j++) {
                    if (i !== j && shiftsWithOffset[i].startHour! < shiftsWithOffset[j].endHour! && shiftsWithOffset[i].endHour! > shiftsWithOffset[j].startHour!) {
                        overlaps.push(j);
                    }
                }
                shiftsWithOffset[i].overlap = overlaps.length + 1;
                // ã‚ªãƒ•ã‚»ãƒƒãƒˆæ±ºå®š (ç°¡æ˜“)
                let occupied = new Set<number>();
                for (let j = 0; j < i; j++) {
                    if (shiftsWithOffset[i].startHour! < shiftsWithOffset[j].endHour! && shiftsWithOffset[i].endHour! > shiftsWithOffset[j].startHour!) {
                        occupied.add(shiftsWithOffset[j].offset);
                    }
                }
                let offset = 0;
                while (occupied.has(offset)) {
                    offset++;
                }
                shiftsWithOffset[i].offset = offset;
            }
           
            const maxOverlaps = Math.max(1, ...shiftsWithOffset.map(s => s.offset + 1));
            const dayWidthPercent = 100; // 1æ—¥åˆ†ã®å¹… (100%)

            return shiftsWithOffset.map((s) => {
              const topOffset = (s.startHour! - GRID_START_HOUR) * 60; // 1h = 60px
              const height = (s.endHour! - s.startHour!) * 60;
             
              const widthPercent = 100 / maxOverlaps;
              const leftOffset = s.offset * widthPercent;

              return (
                <div
                  key={s.memberId}
                  className={`absolute z-10 p-1 rounded border overflow-hidden ${getMemberColor(s.memberId)}`}
                  style={{
                    pointerEvents: 'auto', 
                    top: `${topOffset}px`,
                    height: `${height}px`,
                    left: `calc(${dayIndex * (100 / 7)}% + ${leftOffset * (100 / 7 / 100)}% + 2px)`, // (100/7) = 1æ—¥ã®å¹…
                    width: `calc(${widthPercent * (100 / 7 / 100)}% - 4px)`, // éš™é–“
                    opacity: 0.9,
                  }}
                  title={`${GET_NAME(s.memberId)}: ${s.time}`}
                >
                  <div className="text-[10px] font-semibold">{GET_NAME(s.memberId).split('ï¼ˆ')[0]}</div>
                  <div className="text-[10px]">{s.time}</div>
                </div>
              );
            });
          })}
        </div>
      </div>
    </div>
  );
}

// --- Month View ---
function MonthView({ currentDate, today }: { currentDate: Date, today: Date }) {
  const d = new Date(currentDate);
  d.setDate(1); // 1æ—¥ã«è¨­å®š
  const currentMonth = d.getMonth();
  const todayStr = toDateString(today);

  const monthStart = getWeekStart(d); // æœˆã®ç¬¬1é€±ã®æœˆæ›œæ—¥
 
  const days = Array.from({ length: 42 }).map((_, i) => { // 6é€± * 7æ—¥
    const day = new Date(monthStart);
    day.setDate(day.getDate() + i);
    return day;
  });
 
  const dayNames = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];

  return (
    <div className="flex flex-col h-full">
      {/* --- Day Headers --- */}
      <div className="grid grid-cols-7 shrink-0">
        {dayNames.map(name => (
          <div key={name} className="p-2 text-center text-xs font-semibold text-gray-500 border-b border-r">{name}</div>
        ))}
      </div>
     
      {/* --- Day Cells --- */}
      <div className="grid grid-cols-7 flex-1" style={{ gridTemplateRows: 'repeat(6, minmax(120px, 1fr))' }}> {/* 6è¡Œå›ºå®š */}
        {days.map((day, i) => {
          const dateStr = toDateString(day);
          const isToday = dateStr === todayStr;
          const isCurrentMonth = day.getMonth() === currentMonth;
         
          const dayShiftsData = SHIFTS[dateStr as keyof ShiftData];

          // â–¼â–¼â–¼ [ä¿®æ­£] å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚·ãƒ•ãƒˆæƒ…å ±ï¼ˆä¼‘ã¿å«ã‚€ï¼‰ã‚’ç”Ÿæˆ â–¼â–¼â–¼
          const shifts = MEMBERS.map(member => {
            const shiftData = dayShiftsData?.find(s => s.m === member.id);
            // ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„æ—¥ã¯ã€å½“æœˆãªã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã€å½“æœˆå¤–ãªã‚‰ã€Œä¼‘ã¿ã€
            const time = shiftData ? shiftData.t : (isCurrentMonth ? (Math.random() > 0.4 ? '9:00-18:00' : 'ä¼‘ã¿') : 'ä¼‘ã¿'); 
           
            let displayTime = 'ä¼‘';
            if (time !== 'ä¼‘ã¿' && time.includes('-')) {
                const parts = time.split('-');
                if (parts.length === 2) {
                    displayTime = `${parts[0].split(':')[0]}-${parts[1].split(':')[0]}`; // "9-18"
                } else {
                    displayTime = time; 
                }
            }

            return {
              memberId: member.id,
              name: GET_NAME(member.id),
              time: displayTime,
              isOff: displayTime === 'ä¼‘',
            };
          }).sort((a,b) => a.name.localeCompare(b.name));
           
          const events = ALL_DAY_EVENTS.filter(e => {
              const eventStart = new Date(e.start + 'T00:00:00+09:00');
              const eventEnd = new Date(e.end + 'T00:00:00+09:00');
              return day.getTime() >= eventStart.getTime() && day.getTime() <= eventEnd.getTime();
          });

          return (
            <div 
              key={dateStr}
              className={`p-2 border-b border-r flex flex-col ${isCurrentMonth ? 'bg-white' : 'bg-gray-50'} ${isToday ? 'bg-indigo-50' : ''}`}
            >
              <div className={`text-sm font-medium ${isToday ? 'text-indigo-700' : (isCurrentMonth ? 'text-gray-800' : 'text-gray-400')}`}>
                {day.getDate()}
              </div>
              <div className="mt-1 space-y-0.5 overflow-y-auto flex-1 min-h-0 text-xs">
                  {events.map(e => (
                      <div key={e.id} className={`px-1 rounded text-[10px] font-medium ${e.color} truncate`}>{e.title}</div>
                  ))}
                  {/* â–¼â–¼â–¼ [ä¿®æ­£] å…¨å“¡ã®ã‚·ãƒ•ãƒˆ/ä¼‘ã¿ã‚’è¡¨ç¤º â–¼â–¼â–¼ */}
                  {shifts.map(s => (
                    <div key={s.memberId} className={`flex items-center gap-1 ${s.isOff ? 'text-gray-400' : ''}`}>
                      <PersonIcon className={`w-3 h-3 ${s.isOff ? 'text-gray-300' : getMemberColor(s.memberId).split(' ')[0]} shrink-0`} />
                      <span className="truncate">{s.name.split('ï¼ˆ')[0]}</span>
                      <span className="ml-auto pr-1 text-[10px] font-medium">{s.time}</span>
                    </div>
                  ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// --- DayViewGcal (Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¢¨ã‚¿ã‚¤ãƒ ã‚°ãƒªãƒƒãƒ‰ãƒ»æ—¥) ---
function DayViewGcal({ currentDate, today }: { currentDate: Date, today: Date }) {
  const todayStr = toDateString(today);
  const dateStr = toDateString(currentDate);
  const isToday = dateStr === todayStr;

  const shifts = (SHIFTS[dateStr as keyof ShiftData] || [])
    .map(s => {
      const { startHour, endHour, isOff } = parseShiftTime(s.t);
      return {
        memberId: s.m,
        time: s.t,
        startHour,
        endHour,
        isOff,
      };
    })
    .filter(s => !s.isOff && s.startHour && s.endHour);

  // ã‚·ãƒ•ãƒˆã®é‡ãªã‚Šã‚’è¨ˆç®—
  const shiftsWithOffset = shifts.map(s => ({ ...s, offset: 0, overlap: 1 }));
  for (let i = 0; i < shiftsWithOffset.length; i++) {
      let overlaps = [];
      for (let j = 0; j < shiftsWithOffset.length; j++) {
          if (i !== j && shiftsWithOffset[i].startHour! < shiftsWithOffset[j].endHour! && shiftsWithOffset[i].endHour! > shiftsWithOffset[j].startHour!) {
              overlaps.push(j);
          }
      }
      shiftsWithOffset[i].overlap = overlaps.length + 1;
      // ã‚ªãƒ•ã‚»ãƒƒãƒˆæ±ºå®š (ç°¡æ˜“)
      let occupied = new Set<number>();
      for (let j = 0; j < i; j++) {
          if (shiftsWithOffset[i].startHour! < shiftsWithOffset[j].endHour! && shiftsWithOffset[i].endHour! > shiftsWithOffset[j].startHour!) {
              occupied.add(shiftsWithOffset[j].offset);
          }
      }
      let offset = 0;
      while (occupied.has(offset)) {
          offset++;
      }
      shiftsWithOffset[i].offset = offset;
  }
 
  const allDayEvents = ALL_DAY_EVENTS.filter(e => {
    const start = new Date(e.start + 'T00:00:00+09:00');
    const end = new Date(e.end + 'T00:00:00+09:00');
    return currentDate.getTime() >= start.getTime() && currentDate.getTime() <= end.getTime();
  });
 
  const allDayRowHeight = Math.max(1, allDayEvents.length) * 32 + 8; // 1è¡Œ32px + padding

  const maxOverlaps = Math.max(1, ...shiftsWithOffset.map(s => s.offset + 1));

  return (
    <div className="h-full overflow-auto relative" style={{ minWidth: '300px' }}>
      <div 
        className="grid relative" 
        style={{
          gridTemplateColumns: '60px 1fr', // Time Axis + 1 Day
          gridTemplateRows: `auto auto repeat(${timeSlots.length}, 60px) auto` // Header + AllDay + Slots + Footer(dummy)
        }}
      >
        {/* --- Row 1: Date Header --- */}
        <div className="sticky top-0 z-20 bg-white border-b border-r" style={{ gridColumn: 1, gridRow: 1 }}>&nbsp;</div>
        <div 
          className={`sticky top-0 z-20 bg-white border-b p-2 ${isToday ? 'bg-indigo-50' : ''}`}
          style={{ gridColumn: 2, gridRow: 1 }}
        >
          <div className="text-xs text-gray-500">{['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][currentDate.getDay()]}</div>
          <div className={`text-2xl font-medium ${isToday ? 'text-indigo-700' : 'text-gray-800'}`}>
            {currentDate.getDate()}
          </div>
        </div>
       
        {/* --- Row 2: All-Day --- */}
        <div className="sticky top-[73px] z-20 bg-white border-b border-r text-right pr-2 pt-1 text-xs text-gray-400" style={{ gridColumn: 1, gridRow: 2, height: `${allDayRowHeight}px` }}>çµ‚æ—¥</div>
        <div 
          className="sticky top-[73px] z-20 bg-white border-b p-1"
          style={{ 
            gridColumn: 2,
            gridRow: 2,
            height: `${allDayRowHeight}px`,
          }}
        >
          {allDayEvents.map((event, i) => (
            <div 
              key={event.id}
              className={`h-6 px-2 py-0.5 rounded text-xs font-medium overflow-hidden ${event.color} mx-0.5`}
              style={{
                top: `${i * 28 + 4}px`,
                position: 'relative',
              }}
            >
              {event.title}
            </div>
          ))}
        </div>
       
        {/* --- Rows 3+: Time Grid --- */}
        {/* Time Axis (A3-A15) */}
        {timeSlots.map((hour, hourIndex) => (
            <React.Fragment key={hour}>
            {/* Time Label */}
            <div className="relative text-right pr-2 border-r -mt-2.5" style={{gridColumn: 1, gridRow: hourIndex + 3}}>
                <span className="text-xs text-gray-400 sticky left-0">{hour}:00</span>
              </div>
            {/* Grid Cells (Empty) */}
            <div 
              className="border-b"
              style={{ gridColumn: 2, gridRow: hourIndex + 3 }}
            >
              &nbsp;
            </div>
            </React.Fragment>
        ))}
       
        {/* --- Shift Events (Overlay) --- */}
        <div 
          className="relative"
          style={{
            gridColumn: 2,
            gridRow: `3 / span ${timeSlots.length}`,
            pointerEvents: 'none' 
          }}
        >
          {shiftsWithOffset.map((s) => {
            const topOffset = (s.startHour! - GRID_START_HOUR) * 60; // 1h = 60px
            const height = (s.endHour! - s.startHour!) * 60;
           
            const widthPercent = 100 / maxOverlaps;
            const leftOffset = s.offset * widthPercent;

            return (
              <div
                key={s.memberId}
                className={`absolute z-10 p-1 rounded border overflow-hidden ${getMemberColor(s.memberId)}`}
                style={{
                  pointerEvents: 'auto', 
                  top: `${topOffset}px`,
                  height: `${height}px`,
                  left: `calc(${leftOffset}% + 2px)`,
                  width: `calc(${widthPercent}% - 4px)`, // éš™é–“
                  opacity: 0.9,
                }}
                title={`${GET_NAME(s.memberId)}: ${s.time}`}
              >
                <div className="text-[10px] font-semibold">{GET_NAME(s.memberId).split('ï¼ˆ')[0]}</div>
                <div className="text-[10px]">{s.time}</div>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}


// =================== VoiceTrustV8Style ===================
type Category = 'thanks' | 'fix' | 'help' | 'together' | 'customer';
type TimelineView = 'my' | 'inbox' | 'all';

function VoiceTrustV8Style({ role }: { role: string }){
  // --- State ---
  const [category, setCategory] = useState<Category>('thanks');
  const [timelineView, setTimelineView] = useState<TimelineView>('my');
  const [recipient, setRecipient] = useState<string[]>([]); // å®›å…ˆIDã®é…åˆ—
  const [text, setText] = useState('');
  const [anonymous, setAnonymous] = useState(false);
  const [recipientDropdownOpen, setRecipientDropdownOpen] = useState(false);
 
  // --- æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ (ãƒ€ãƒŸãƒ¼) ---
  const [myPosts, setMyPosts] = useState<Post[]>(MY_POSTS);
  const [inboxPosts, setInboxPosts] = useState<Post[]>(INBOX_POSTS);
  const [allPublicPosts, setAllPublicPosts] = useState<Post[]>(ALL_PUBLIC_POSTS);

  // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
  const [modalOpen, setModalOpen] = useState(false);
  const [modalTitle, setModalTitle] = useState('');
  const [modalPosts, setModalPosts] = useState<Post[]>([]);
  const previewCount = 3; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§è¡¨ç¤ºã™ã‚‹ä»¶æ•°

  // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ (ãƒ€ãƒŸãƒ¼) ---
  const currentUser = USER;
  const members = MEMBERS;
  const getMemberName = GET_NAME;
  const formatTs = FORMAT_TS;
 
  // --- Ref for dropdown ---
  const recipientRef = useRef<HTMLDivElement>(null);

  // --- Constants (UI) ---
  /* â–¼â–¼â–¼ [ä¿®æ­£] categoryTitle ã¨ categoryDesc ã‚’ categoryUI ã«çµ±åˆã—ã€tab ã¨ header ã‚’åˆ†é›¢ â–¼â–¼â–¼ */
  /* â–¼â–¼â–¼ [V2ä¿®æ­£] çµµæ–‡å­—ã‚’å‰Šé™¤ã—ã¦æ–‡å­—åŒ–ã‘ã‚’é˜²æ­¢ â–¼â–¼â–¼ */
  const categoryUI = {
    thanks: { 
      tab: 'æ„Ÿè¬ğŸ˜Š', 
      header: 'ã‚ã‚ŠãŒã¨ã†ã‚’ä¼ãˆã‚‹ğŸ˜Š',
      desc: 'ã¡ã‚‡ã£ã¨ã—ãŸæ„Ÿè¬ã‚’ã²ã¨ã“ã¨ã§ã€‚' 
    },
    fix: { 
      tab: 'ãªãŠã—ã¦ğŸ’¡', 
      header: 'ã“ã“ç›´ã—ã¦ã»ã—ã„ğŸ’¡',
      desc: 'æ”¹å–„ã—ã¦ã»ã—ã„ç‚¹ã‚’å…·ä½“çš„ã«ã€‚'
    },
    help: { 
      tab: 'ãŸã™ã‘ã¦ğŸ« ', 
      header: 'å›°ã£ã¦ã¾ã™ğŸ« ',
      desc: 'æ¥­å‹™ã§å›°ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç›¸è«‡ã€‚'
    },
    together: { 
      tab: 'ã„ã£ã—ã‚‡ã«ğŸ¤', 
      header: 'ã„ã£ã—ã‚‡ã«ã‚„ã‚Šã¾ã—ã‚‡ã†ğŸ¤',
      desc: 'ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ææ¡ˆã€‚'
    },
    customer: { 
      tab: 'ãŠå®¢ã•ã¾ã®å£°ğŸ—£ï¸', 
      header: 'å¤§åˆ‡ãªãŠå®¢ã•ã¾ã®å£°ã‚’å…±æœ‰ğŸ—£ï¸',
      desc: 'å°è±¡ã«æ®‹ã£ãŸãŠå®¢ã•ã¾ã®è¨€è‘‰ã‚’è¦ç´„ã—ã€èƒŒæ™¯ã‚„æ°—ä»˜ãã‚’ã²ã¨ã“ã¨ã§ã€‚'
    },
  };
  /* â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² */
  
  const catTheme = {
    thanks: { tab: 'bg-red-100 text-red-700 hover:bg-red-200 focus:bg-red-600 focus:text-white', active: 'bg-red-600 text-white', bg: 'bg-red-50/50', button: 'bg-red-500 hover:bg-red-600' },
    fix: { tab: 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200 focus:bg-yellow-500 focus:text-white', active: 'bg-yellow-500 text-white', bg: 'bg-yellow-50/50', button: 'bg-yellow-500 hover:bg-yellow-600' },
    help: { tab: 'bg-blue-100 text-blue-700 hover:bg-blue-200 focus:bg-blue-500 focus:text-white', active: 'bg-blue-500 text-white', bg: 'bg-blue-50/50', button: 'bg-blue-500 hover:bg-blue-600' },
    together: { tab: 'bg-green-100 text-green-700 hover:bg-green-200 focus:bg-green-500 focus:text-white', active: 'bg-green-500 text-white', bg: 'bg-green-50/50', button: 'bg-green-500 hover:bg-green-600' },
    customer: { tab: 'bg-purple-100 text-purple-700 hover:bg-purple-200 focus:bg-purple-600 focus:text-white', active: 'bg-purple-600 text-white', bg: 'bg-purple-50/50', button: 'bg-purple-600 hover:bg-purple-700' },
  };
  const placeholderByCat = {
    thanks: 'ä¾‹ï¼šèª°ã«ãƒ»ã©å¯¾å¿œãŒè‰¯ã‹ã£ãŸï¼Ÿã€Œã€‡ã€‡ã•ã‚“ã€ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°ç¥å¯¾å¿œã§ã—ãŸï¼ã€',
    fix: 'ä¾‹ï¼šã©ã®æ¥­å‹™ãƒ»ä½•ãŒå¤‰ï¼Ÿã€Œãƒ†ã‚¹ã‚¿ãƒ¼ã®è£œå……ãƒ«ãƒ¼ãƒ«ã€å°ç·šãŒæ‚ªã™ãï¼ã€',
    help: 'ä¾‹ï¼šã©ã®æ¥­å‹™ãƒ»ä½•ãŒä¸æ˜ï¼Ÿã€Œã‚®ãƒ•ãƒˆåŒ…è£…ã®ãƒ‘ã‚¿ãƒ¼ãƒ³Bã€ã¾ã è‡ªä¿¡ãªã„ã§ã™â€¦ã€',
    together: 'ä¾‹ï¼šä½•ã‚’ãƒ»ã©ã†ã—ãŸã„ï¼Ÿã€Œæ–°äººå‘ã‘ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã€ã‚‚ã£ã¨ç°¡ç´ åŒ–ã—ã¾ã›ã‚“ã‹ï¼Ÿã€',
    customer: 'ä¾‹ï¼šè¦ç´„ï¼‹èƒŒæ™¯ã€Œæ•æ„Ÿè‚Œã®æ–¹ã‹ã‚‰â€œã“ã®åŒ–ç²§æ°´ã¯åˆºæ¿€ãŒå°‘ãªã„â€ã¨ï¼“åã€',
  };
 
  // --- Effects ---
  // Dropdown ã‚’å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (recipientRef.current && !recipientRef.current.contains(event.target as Node)) {
        setRecipientDropdownOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [recipientRef]);

  // --- Handlers ---
  const handleCategoryChange = (val: string) => {
    setCategory(val as Category);
    // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚ã¯å®›å…ˆã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    setRecipient([]);
    setText('');
    setAnonymous(false);
  };
 
  const handleSubmit = () => {
    if (!text.trim() || recipient.length === 0) return;
    
    const newPost: Post = {
      id: `m${Date.now()}`,
      authorId: anonymous ? 'anonymous' : currentUser.id,
      recipient: recipient.length === 1 ? recipient[0] : recipient, // å®›å…ˆ
      /* â–¼â–¼â–¼ [ä¿®æ­£] æŠ•ç¨¿æœ¬æ–‡ã«å«ã‚ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨é€£å‹•ã•ã›ã‚‹ â–¼â–¼â–¼ */
      text: `ã€${categoryUI[category].header}ã€‘${text}`, // categoryTitle -> categoryUI[category].header
      ts: Date.now(),
      reactions: [],
    };
   
    // è‡ªåˆ†ã®æŠ•ç¨¿ã«è¿½åŠ 
    setMyPosts([newPost, ...myPosts]);
   
    // å®›å…ˆãŒ 'zen' (å…¨ä½“) ãªã‚‰ 'ã¿ã‚“ãª' ã«ã‚‚è¿½åŠ 
    /* â–¼â–¼â–¼ [ä¿®æ­£] 'zen' å®›ã§ãªãã¦ã‚‚ã€'ã¿ã‚“ãª' ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«è¿½åŠ ã™ã‚‹ â–¼â–¼â–¼ */
    setAllPublicPosts([newPost, ...allPublicPosts]);
    /* â–²â–²â–² ä¿®æ­£ â–²â–²â–² */
    
    // å®›å…ˆãŒè‡ªåˆ†ã§ãªã„å ´åˆã€ãƒ€ãƒŸãƒ¼ã§ç›¸æ‰‹ã®INBOXã«ã‚‚è¿½åŠ  (ãƒ‡ãƒ¢ç”¨)
    if (recipient.includes('sato')) {
      setInboxPosts([{...newPost, id:`i${Date.now()}`, replied: false}, ...inboxPosts]);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    setText('');
    setRecipient([]);
    setAnonymous(false);
    setRecipientDropdownOpen(false);
  };

  /* â–¼â–¼â–¼ [è¿½åŠ ] ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ãƒãƒ³ãƒ‰ãƒ© â–¼â–¼â–¼ */
  const handleReaction = (postId: string, emoji: string) => {
    const loginUserId = currentUser.id;

    const updatePostList = (posts: Post[]): Post[] => {
      return posts.map(p => {
        if (p.id !== postId) return p;

        let newReactions = [...p.reactions];
        const existingReactionIndex = newReactions.findIndex(r => r.emoji === emoji);

        if (existingReactionIndex > -1) {
          // çµµæ–‡å­—ãŒæ—¢ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é…åˆ—ã«å­˜åœ¨ã™ã‚‹
          const reaction = newReactions[existingReactionIndex];
          const userIndex = reaction.by.indexOf(loginUserId);

          if (userIndex > -1) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«ã“ã®çµµæ–‡å­—ã§ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ã¦ã„ã‚‹ -> ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
            reaction.by.splice(userIndex, 1);
            reaction.count = reaction.by.length;
            if (reaction.count === 0) {
              // èª°ã‚‚ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ã¦ã„ãªã‘ã‚Œã°ã€çµµæ–‡å­—ã®ã‚¨ãƒ³ãƒˆãƒªè‡ªä½“ã‚’å‰Šé™¤
              newReactions.splice(existingReactionIndex, 1);
            }
          } else {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã®çµµæ–‡å­—ã§ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ã¦ã„ãªã„ -> ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
            reaction.by.push(loginUserId);
            reaction.count = reaction.by.length;
          }
        } else {
          // ã“ã®æŠ•ç¨¿ã«å¯¾ã™ã‚‹æ–°ã—ã„çµµæ–‡å­—ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          newReactions.push({ emoji, count: 1, by: [loginUserId] });
        }
        return { ...p, reactions: newReactions };
      });
    };

    // ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®stateã‚’æ›´æ–°
    setMyPosts(updatePostList);
    setInboxPosts(updatePostList);
    setAllPublicPosts(updatePostList);
  };
  /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */


  const openModal = (view: TimelineView) => {
    if (view === 'my') {
      setModalTitle('ã‚ãªãŸã®æŠ•ç¨¿ï¼ˆã™ã¹ã¦ï¼‰');
      setModalPosts(myPosts);
    } else if (view === 'inbox') {
      setModalTitle('ã‚ãªãŸå®›ã¦ã®æŠ•ç¨¿ï¼ˆã™ã¹ã¦ï¼‰');
      setModalPosts(inboxPosts);
    } else {
      setModalTitle('ã¿ã‚“ãªã®æŠ•ç¨¿ï¼ˆã™ã¹ã¦ï¼‰');
      setModalPosts(allPublicPosts);
    }
    setModalOpen(true);
  };
 
  /* â–¼â–¼â–¼ [è¿½åŠ ] ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ â–¼â–¼â–¼ */
  const ReactionBar = ({ post }: { post: Post }) => {
    const [showPicker, setShowPicker] = useState(false);
    // Slacké¢¨ã®ä¸»è¦ãªçµµæ–‡å­—
    const EMOJIS = ['ğŸ‘', 'ğŸ˜Š', 'â¤ï¸', 'ğŸ‰', 'ğŸ’¡', 'ğŸ¤”'];
    const loginUserId = currentUser.id;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ãŸçµµæ–‡å­—ã®ã‚»ãƒƒãƒˆ
    const userReactions = new Set(post.reactions.filter(r => r.by.includes(loginUserId)).map(r => r.emoji));

    const handleEmojiClick = (emoji: string) => {
      handleReaction(post.id, emoji);
      setShowPicker(false);
    };
    
    return (
      <div className="flex items-center gap-2 relative">
        {/* é›†è¨ˆã•ã‚ŒãŸãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */}
        {post.reactions.map(r => (
          <button
            key={r.emoji}
            onClick={() => handleEmojiClick(r.emoji)}
            className={`flex items-center gap-1 px-2 py-0.5 rounded-full text-xs transition-all ${
              userReactions.has(r.emoji)
              ? 'bg-indigo-600 text-white' // è‡ªåˆ†ãŒãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¸ˆã¿
              : 'bg-gray-100 hover:bg-gray-200 text-gray-600 border border-gray-200'
            }`}
          >
            <span>{r.emoji}</span>
            <span className="font-semibold">{r.count}</span>
          </button>
        ))}
        
        {/* çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ãƒœã‚¿ãƒ³ */}
        <button 
          onClick={() => setShowPicker(!showPicker)}
          className="p-1 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700"
        >
          {/* Slacké¢¨ã®ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆChatIconã§ä»£ç”¨ï¼‰ */}
          <ChatIcon className="w-4 h-4" /> 
        </button>
        
        {/* çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ */}
        {showPicker && (
          <div className="absolute top-7 left-0 z-10 bg-white shadow-lg rounded-full border border-gray-200 p-1 flex gap-1">
            {EMOJIS.map(emoji => (
              <button
                key={emoji}
                onClick={() => handleEmojiClick(emoji)}
                className="text-base p-1.5 rounded-full hover:bg-gray-100 transition-transform active:scale-90"
              >
                {emoji}
              </button>
            ))}
          </div>
        )}
      </div>
    );
  };
  /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

  // --- Render ---
  const renderPost = (p: Post, view: TimelineView) => {
    const authorName = p.authorId === 'anonymous' ? 'åŒ¿å' : getMemberName(p.authorId);
    let recipientName = '';
   
    if (Array.isArray(p.recipient)) {
      recipientName = p.recipient.map(getMemberName).join(', ');
    } else {
      recipientName = getMemberName(p.recipient);
    }

    /* â–¼â–¼â–¼ [ä¿®æ­£] 'ã¿ã‚“ãª' (all) ãƒ“ãƒ¥ãƒ¼ã®æ™‚ã¯ From -> To å½¢å¼ã§è¡¨ç¤º â–¼â–¼â–¼ */
    let title = '';
    if (view === 'my') {
      title = `To: ${recipientName}`;
    } else if (view === 'inbox') {
      title = `From: ${authorName}`;
    } else { // 'all'
      /* â–¼â–¼â–¼ [ä¿®æ­£] 'From: (å·®å‡ºäºº) â†’ To: (å®›å…ˆ)' ã®å½¢å¼ã«å¤‰æ›´ â–¼â–¼â–¼ */
      title = `From: ${authorName} â†’ To: ${recipientName}`;
    }
    /* â–²â–²â–² ä¿®æ­£ â–²â–²â–² */

    return (
      <div key={p.id} className="py-3 border-b last:border-b-0">
        <div className="flex items-center justify-between text-xs text-gray-500 mb-1">
          <span className="font-semibold">{title}</span>
          <span>{formatTs(p.ts)}</span>
        </div>
        <p className="text-sm text-gray-800 whitespace-pre-line">{p.text}</p>
        <div className="flex items-center justify-between mt-2">
          {/* Reactions */}
          {/* â–¼â–¼â–¼ [ä¿®æ­£] é™çš„ãªè¡¨ç¤ºã‹ã‚‰ ReactionBar ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¤‰æ›´ â–¼â–¼â–¼ */}
          <ReactionBar post={p} />
          {/* â–²â–²â–² ä¿®æ­£ â–²â–²â–² */}
          {/* Reply Status */}
          {view === 'inbox' && !p.replied && (
            <span className="text-xs font-semibold text-rose-600 bg-rose-50 px-2 py-0.5 rounded-full">æœªè¿”ä¿¡</span>
          )}
        </div>
      </div>
    );
  };

  return (
    <div className="w-full max-w-6xl mx-auto">
      <div className="text-center mb-6">
        <h1 className="text-2xl sm:text-3xl font-extrabold tracking-tight text-gray-900 leading-tight">
          <span className="bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">tsumugi</span> ã²ã¨ã“ã¨ãƒœãƒ¼ãƒ‰
        </h1>
        <p className="text-sm text-gray-600 mt-1">ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’é«˜ã‚ã‚‹ãŸã‚ã®å°ã•ãªç™ºä¿¡ãƒ„ãƒ¼ãƒ«</p>
      </div>

      {/* --- 1. ã‚«ãƒ†ã‚´ãƒªé¸æŠ --- */}
      <VoiceTabs value={category} onChange={handleCategoryChange}>
        <VoiceTabList>
          {Object.keys(catTheme).map(catKey => {
            const key = catKey as Category;
            return (
              <VoiceTab key={key} value={key} className={`${category === key ? catTheme[key].active : catTheme[key].tab}`}>
                {categoryUI[key].tab} {/* â–¼â–¼â–¼ [ä¿®æ­£] categoryTitle -> categoryUI[key].tab â–¼â–¼â–¼ */ }
              </VoiceTab> 
            )
          })}
        </VoiceTabList>

        {/* --- 2. æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  --- */}
        {Object.keys(catTheme).map(catKey => {
          const key = catKey as Category;
          return (
            <VoiceTabPanel key={key} when={key}>
              <Card className={`shadow-lg transition-all duration-300 ${catTheme[key].bg}`}>
                <CardHeader className="pb-3">
                  <div className="flex flex-wrap items-baseline gap-x-3 gap-y-1">
                    <div className="text-2xl sm:text-3xl font-extrabold text-gray-900">
                      {categoryUI[key].header} {/* â–¼â–¼â–¼ [ä¿®æ­£] categoryTitle -> categoryUI[key].header â–¼â–¼â–¼ */ }
                    </div>
                    <div className="text-sm text-gray-600">
                      {categoryUI[key].desc} {/* â–¼â–¼â–¼ [ä¿®æ­£] categoryDesc -> categoryUI[key].desc â–¼â–¼â–¼ */ }
                    </div>
                  </div>
                </CardHeader>
                <CardContent className="grid gap-4">
                  <div className="flex items-center gap-2">
                    <span className="text-sm text-gray-700 font-medium">èª°ã«é€ã‚Šã¾ã™ã‹ï¼Ÿ</span>
                   
                    <div className="relative w-full" ref={recipientRef}>
                      <button
                        onClick={() => setRecipientDropdownOpen(prev => !prev)}
                        className="w-full bg-white border border-gray-300 rounded-lg px-3 py-2 h-10 text-sm text-left flex items-center justify-between"
                      >
                        <span className="truncate">
                          {recipient.length === 0 && 'å®›å…ˆã‚’é¸æŠ'}
                          {recipient.length > 0 && recipient.map(getMemberName).join(', ')}
                        </span>
                        <span>â–¼</span>
                      </button>

                      {recipientDropdownOpen && (
                        <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                          {members
                            .filter((m) => m.id !== currentUser.id)
                            .map((m) => (
                              <label
                                key={m.id}
                                className="flex items-center gap-2 p-2 text-sm hover:bg-gray-50 cursor-pointer"
                              >
                                <input
                                  type="checkbox"
                                  className="w-4 h-4"
                                  checked={recipient.includes(m.id)}
                                  onChange={(e) => {
                                    const memberId = m.id;
                                    const isChecked = e.target.checked;
                                    setRecipient(prev =>
                                      isChecked
                                        ? (memberId === 'zen' ? ['zen'] : [...prev.filter(id => id !== 'zen'), memberId])
                                        : (memberId === 'zen' ? [] : prev.filter(id => id !== memberId))
                                    );
                                    if (memberId === 'zen' && isChecked) {
                                      setRecipientDropdownOpen(false);
                                    }
                                  }}
                                />
                                {m.name}
                              </label>
                            ))}
                        </div>
                      )}
                    </div>
                  </div>
                 
                  <Textarea
                    placeholder={placeholderByCat[key]}
                    value={text}
                    onChange={(e) => setText(e.target.value)}
                    className="min-h-[120px] border-gray-300 focus:border-indigo-500"
                  />
                 
                  <div className="flex items-center justify-between">
                    <label className="flex items-center gap-2 text-sm select-none">
                      <input
                        type="checkbox"
                        checked={anonymous}
                        onChange={(e) => setAnonymous(e.target.checked)}
                        className="w-4 h-4"
                      />
                      åŒ¿åã§æŠ•ç¨¿
                    </label>
                    <Button 
                      disabled={!text.trim()} 
                      onClick={handleSubmit}
                      className={`transition-all ${catTheme[key].button} ${!text.trim() ? 'opacity-50' : ''}`}
                    >
                      é€ä¿¡ã™ã‚‹ğŸš€
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </VoiceTabPanel>
          )
        })}
      </VoiceTabs>

      {/* --- 3. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ --- */}
      <div className="mt-6">
        <Tabs value={timelineView} onChange={(v) => setTimelineView(v as TimelineView)}>
          <TabList className="bg-gray-100 rounded-t-lg border-gray-200 sticky top-16 z-10 shadow-inner inset-x-0 px-1 sm:px-4">
            <Tab value="my" className={`flex-1 sm:flex-initial ${timelineView === 'my' ? 'border-indigo-600 text-indigo-700' : 'border-transparent text-gray-600 hover:text-gray-800'}`}>
              <SendIcon className="w-5 h-5 sm:mr-1.5"/>
              <span className="hidden sm:inline">ã‚ãªãŸç™ºï¼ˆ{myPosts.length}ï¼‰</span>
            </Tab>
            <Tab value="inbox" className={`flex-1 sm:flex-initial ${timelineView === 'inbox' ? 'border-indigo-600 text-indigo-700' : 'border-transparent text-gray-600 hover:text-gray-800'}`}>
              <InboxIcon className="w-5 h-5 sm:mr-1.5"/>
              <span className="hidden sm:inline">ã‚ãªãŸå®›ï¼ˆ{inboxPosts.length}ï¼‰</span>
            </Tab>
            <Tab value="all" className={`flex-1 sm:flex-initial ${timelineView === 'all' ? 'border-indigo-600 text-indigo-700' : 'border-transparent text-gray-600 hover:text-gray-800'}`}>
              <UsersIcon className="w-5 h-5 sm:mr-1.5"/>
              <span className="hidden sm:inline">ã¿ã‚“ãªï¼ˆ{allPublicPosts.length}ï¼‰</span>
            </Tab>
          </TabList>

          <Card className="rounded-t-none">
            <CardContent className="pt-5">
              <TabPanel when="my">
                {myPosts.length > 0 ? (
                  myPosts.slice(0, previewCount).map(p => renderPost(p, 'my'))
                ) : (
                  <p className="text-sm text-gray-500">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                )}
                {myPosts.length > previewCount && <Button variant="outline" size="sm" className="w-full mt-2" onClick={() => openModal('my')}>ã™ã¹ã¦è¦‹ã‚‹ï¼ˆ{myPosts.length}ä»¶ï¼‰</Button>}
              </TabPanel>

              <TabPanel when="inbox">
                {inboxPosts.length > 0 ? (
                  inboxPosts.slice(0, previewCount).map(p => renderPost(p, 'inbox'))
                ) : (
                  <p className="text-sm text-gray-500">ã‚ãªãŸå®›ã¦ã®æŠ•ç¨¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                )}
                {inboxPosts.length > previewCount && <Button variant="outline" size="sm" className="w-full mt-2" onClick={() => openModal('inbox')}>ã™ã¹ã¦è¦‹ã‚‹ï¼ˆ{inboxPosts.length}ä»¶ï¼‰</Button>}
              </TabPanel>

              <TabPanel when="all">
                {allPublicPosts.length > 0 ? (
                  allPublicPosts.slice(0, previewCount).map(p => renderPost(p, 'all'))
                ) : (
                  <p className="text-sm text-gray-500">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                )}
                {allPublicPosts.length > previewCount && <Button variant="outline" size="sm" className="w-full mt-2" onClick={() => openModal('all')}>ã™ã¹ã¦è¦‹ã‚‹ï¼ˆ{allPublicPosts.length}ä»¶ï¼‰</Button>}
              </TabPanel>
            </CardContent>
          </Card>
        </Tabs>
      </div>


      {/* --- æŠ•ç¨¿é–²è¦§ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« --- */}
      <Modal open={modalOpen} title={modalTitle} onClose={()=>setModalOpen(false)}>
        <div className="max-h-[60vh] overflow-y-auto pr-2">
          {modalPosts.length > 0 ? (
            modalPosts.map(p => renderPost(p, 
              modalTitle.includes('ã‚ãªãŸ') ? (modalTitle.includes('å®›ã¦') ? 'inbox' : 'my') : 'all'
            ))
          ) : (
            <p className="text-sm text-gray-500">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          )}
        </div>
      </Modal>
    </div>
  );
}
/* â–²â–²â–² å¾©å…ƒã“ã“ã¾ã§ â–²â–²â–² */


// =================== KnowledgeBase (Boxé¢¨UI) ===================
function KnowledgeBase({ role }: { role: string }){
  const [viewMode, setViewMode] = useState('latest'); // 'latest', 'all_files', 'all_messages'
  const [aiOpen, setAiOpen] = useState(false);
  const [aiTarget, setAiTarget] = useState<KnowledgeFile | Notice | null>(null);
  const [managerMsg, setManagerMsg] = useState<Notice[]>([...INITIAL_NOTICES, { id:'n2', title:'ã€å†é€ã€‘å¹´æœ«èª¿æ•´ã®å¯¾å¿œ', body:'æœªæå‡ºè€…ã¯æœ¬æ—¥ä¸­ã«å¿…ãšå¯¾å¿œã—ã¦ãã ã•ã„ã€‚', created:'2025-10-28 10:00' }, { id:'n3', title:'æ£šå¸ã—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«', body:'ä»Šé€±æœ«ã®æ£šå¸ã—æ‹…å½“ã¯æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªã€‚', created:'2025-10-27 15:00' }, { id:'n4', title:'MTGã‚­ãƒ£ãƒ³ã‚»ãƒ«', body:'æœ¬æ—¥ã®å¤•ç¤¼ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ã™ã€‚', created:'2025-10-27 09:00' }]);
  const [draftTitle, setDraftTitle] = useState('');
  const [draftBody, setDraftBody] = useState('');
  const allFolders = KNOWLEDGE_FOLDERS;
  const allFiles = KNOWLEDGE; 

  const sorted = [...KNOWLEDGE].sort((a,b)=> new Date(b.uploaded).getTime() - new Date(a.uploaded).getTime());
  const imp = sorted.filter(x=>x.important);
  const latest = sorted.slice(0,5);
  const primary = Array.from(new Set([...imp, ...latest]));

  const addMsg = ()=>{
    if(role!=='manager' || !draftTitle.trim() || !draftBody.trim()) return;
    const created = new Date().toLocaleString('ja-JP',{timeZone:'Asia/Tokyo'});
    setManagerMsg([{ id:`n${Date.now()}`, title:draftTitle, body:draftBody, created }, ...managerMsg]);
    setDraftTitle(''); setDraftBody('');
  };

  const openAISummary = (f: KnowledgeFile)=>{ 
    setAiTarget(f); 
    setAiOpen(true); 
  };
 
  // --- å…±é€š: ãƒ•ã‚¡ã‚¤ãƒ«ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
  const FileCard = ({ f }: { f: KnowledgeFile }) => (
    <div key={f.id} className="border rounded-xl p-4 bg-white shadow-sm hover:shadow-md transition-shadow">
      <div className="flex items-start gap-3">
        {f.important && <span className="text-yellow-500 pt-0.5"><StarIcon className="w-5 h-5"/></span>}
        <div className="flex-1">
          <div className="font-semibold text-gray-800">{f.title}</div>
          <div className="text-xs text-gray-500">{f.type} â€¢ {f.uploaded} â€¢ {f.size}</div>
          <div className="mt-3 flex gap-2">
            <Button variant="outline" size="sm">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</Button>
            <Button variant="primary" size="sm" onClick={()=>openAISummary(f)}>
              <SparklesIcon className="w-4 h-4 mr-1.5"/>AIè¦ç´„ã‚’è¦‹ã‚‹
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
 
  // --- å…±é€š: åº—é•·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ ---
  const MsgCard = ({ m }: { m: Notice }) => (
    <div className="border rounded-xl p-4 bg-white shadow-sm hover:shadow-md transition-shadow cursor-pointer" onClick={()=>{ setAiTarget(m); setAiOpen(true); }}>
      <div className="font-semibold text-gray-800">{m.title}</div>
      <div className="text-xs text-gray-500 mb-2">{m.created}</div>
      <p className="text-sm text-gray-600 line-clamp-2">{m.body}</p>
    </div>
  );

  if(viewMode === 'all_files'){ 
    return (
      <div className="max-w-6xl mx-auto space-y-6">
        <div className="flex items-center justify-between">
          <h1 className="text-xl font-semibold">ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆBoxï¼‰</h1>
          <Button variant="outline" size="sm" onClick={()=>setViewMode('latest')}>æœ€æ–°ã«æˆ»ã‚‹</Button>
        </div>
       
        <Card>
          <CardHeader>
            <div className="text-base font-semibold">ãƒ•ã‚¡ã‚¤ãƒ«é€šé”ï¼ˆãƒ•ã‚©ãƒ«ãƒ€åˆ¥ï¼‰</div>
            <div className="text-xs text-gray-500">AIè¦ç´„ä»˜ãã®ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã§ã™ã€‚</div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
              {allFolders.map(folder => (
                <div key={folder.id} className="border rounded-lg p-3 flex items-center gap-3 hover:bg-gray-50 cursor-pointer">
                  <FolderIcon className="w-6 h-6 text-indigo-500"/>
                  <div>
                    <div className="text-sm font-medium">{folder.name}</div>
                    <div className="text-xs text-gray-500">æ›´æ–°: {folder.updated}</div>
                  </div>
                </div>
              ))}
            </div>
           
            <div className="border rounded-lg overflow-hidden">
              <div className="hidden md:grid grid-cols-12 px-4 py-2 text-xs text-gray-500 bg-gray-50 font-medium">
                <div className="col-span-5">ãƒ•ã‚¡ã‚¤ãƒ«å</div>
                <div className="col-span-2">ãƒ•ã‚©ãƒ«ãƒ€</div>
                <div className="col-span-2">æœ€çµ‚æ›´æ–°</div>
                <div className="col-span-3 text-right">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
              </div>
              {allFiles.map(f => (
                <div key={f.id} className="grid grid-cols-1 md:grid-cols-12 px-4 py-3 items-center border-t text-sm">
                  <div className="col-span-12 md:col-span-5 flex items-center gap-2 mb-2 md:mb-0">
                    {f.type === 'PDF' ? <FileIcon className="w-5 h-5 text-rose-500"/> : <FileIcon className="w-5 h-5 text-blue-500"/>}
                    <span className="font-medium text-gray-800">{f.title}</span>
                    {f.important && <span className="text-yellow-500"><StarIcon className="w-4 h-4"/></span>}
                  </div>
                  <div className="col-span-12 md:col-span-2 text-xs text-gray-600 md:text-sm">
                    {allFolders.find(fold => fold.id === f.folderId)?.name || 'ãƒ«ãƒ¼ãƒˆ'}
                  </div>
                  <div className="col-span-12 md:col-span-2 text-xs text-gray-500 md:text-sm">{f.uploaded}</div>
                  <div className="col-span-12 md:col-span-3 flex items-center gap-2 justify-start md:justify-end mt-2 md:mt-0">
                    <Button variant="outline" size="sm">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</Button>
                    <Button variant="primary" size="sm" onClick={()=>openAISummary(f)}>
                      <SparklesIcon className="w-4 h-4 mr-1"/>AIè¦ç´„
                    </Button>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        <Modal open={aiOpen} title={aiTarget? (('body' in aiTarget) ? aiTarget.title : `${aiTarget.title} ã®AIè¦ç´„`) : ''} onClose={()=>setAiOpen(false)}>
          {aiTarget && ('body' in aiTarget ? <div className="whitespace-pre-line">{aiTarget.body}</div> : <div className="space-y-2"><p>ï¼ˆãƒ€ãƒŸãƒ¼AIè¦ç´„ï¼‰</p><p>1. é‡è¦ãƒã‚¤ãƒ³ãƒˆã¯ã€Œãƒªãƒ”ã‚¸ãƒ¥ã‚¢EXã€ã§ã™ã€‚</p><p>2. ç¾å ´ã§ã¯ã€Œæ•æ„Ÿè‚Œã®ãŠå®¢æ§˜ã€ã¸ã®å£°ã‹ã‘ã‚’å¾¹åº•ã—ã¦ãã ã•ã„ã€‚</p><p>3. æ³¨æ„äº‹é …ã¯ã€Œæ—¢å­˜å“ã¨ã®ä½µç”¨ã¯éæ¨å¥¨ã€ã§ã™ã€‚</p></div>)}
        </Modal>
      </div>
    );
  }

  if(viewMode === 'all_messages'){
    return (
      <div className="max-w-6xl mx-auto space-y-6">
        <div className="flex items-center justify-between">
          <h1 className="text-xl font-semibold">ã™ã¹ã¦ã®åº—é•·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h1>
          <Button variant="outline" size="sm" onClick={()=>setViewMode('latest')}>æœ€æ–°ã«æˆ»ã‚‹</Button>
        </div>
       
        <Card>
          <CardHeader>
            <div className="text-base font-semibold">åº—é•·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå…¨ä»¶ï¼‰</div>
            <div className="text-xs text-gray-500">AIè¦ç´„ãªã—ã®çŸ­æ–‡é€šé”ã§ã™ã€‚</div>
          </CardHeader>
          {role==='manager' && (
            <CardContent className="border-b grid gap-2">
              <div className="text-sm font-semibold">æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ</div>
              <Input placeholder="ã‚¿ã‚¤ãƒˆãƒ«" value={draftTitle} onChange={e=>setDraftTitle(e.target.value)} />
              <Textarea rows={3} placeholder="æœ¬æ–‡ï¼ˆçŸ­æ–‡ã§OKï¼‰" value={draftBody} onChange={e=>setDraftBody(e.target.value)} />
              <div className="text-right"><Button onClick={addMsg} disabled={!draftTitle.trim() || !draftBody.trim()}>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ </Button></div>
            </CardContent>
          )}
          <CardContent className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {managerMsg.map(m => <MsgCard key={m.id} m={m} />)}
          </CardContent>
        </Card>

        <Modal open={aiOpen} title={aiTarget? (('body' in aiTarget) ? aiTarget.title : `${aiTarget.title} ã®AIè¦ç´„`) : ''} onClose={()=>setAiOpen(false)}>
          {aiTarget && ('body' in aiTarget ? <div className="whitespace-pre-line">{aiTarget.body}</div> : <div className="space-y-2"><p>ï¼ˆãƒ€ãƒŸãƒ¼AIè¦ç´„ï¼‰</p><p>1. é‡è¦ãƒã‚¤ãƒ³ãƒˆã¯ã€Œãƒªãƒ”ã‚¸ãƒ¥ã‚¢EXã€ã§ã™ã€‚</p><p>2. ç¾å ´ã§ã¯ã€Œæ•æ„Ÿè‚Œã®ãŠå®¢æ§˜ã€ã¸ã®å£°ã‹ã‘ã‚’å¾¹åº•ã—ã¦ãã ã•ã„ã€‚</p><p>3. æ³¨æ„äº‹é …ã¯ã€Œæ—¢å­˜å“ã¨ã®ä½µç”¨ã¯éæ¨å¥¨ã€ã§ã™ã€‚</p></div>)}
        </Modal>
      </div>
    );
  }


  // --- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€æ–°ï¼‰ ---
  return (
    <div className="max-w-6xl mx-auto space-y-6">
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <div className="text-base font-semibold">åº—é•·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæœ€æ–°ï¼‰</div>
              <div className="text-xs text-gray-500">AIè¦ç´„ãªã—ã€‚ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºã€‚</div>
            </div>
            <Button variant="link" size="sm" onClick={()=>setViewMode('all_messages')}>éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã‚‹</Button>
          </div>
        </CardHeader>
        <CardContent className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          {managerMsg.slice(0,3).map(m => <MsgCard key={m.id} m={m} />)}
        </CardContent>
        {role==='manager' && (
          <CardContent className="border-t">
            <div className="text-xs text-gray-500 mb-2">æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ</div>
            <div className="grid gap-2">
              <Input placeholder="ã‚¿ã‚¤ãƒˆãƒ«" value={draftTitle} onChange={e=>setDraftTitle(e.target.value)} />
              <Textarea rows={3} placeholder="æœ¬æ–‡ï¼ˆçŸ­æ–‡ã§OKï¼‰" value={draftBody} onChange={e=>setDraftBody(e.target.value)} />
              <div className="text-right"><Button onClick={addMsg} disabled={!draftTitle.trim() || !draftBody.trim()}>è¿½åŠ </Button></div>
            </div>
          </CardContent>
        )}
      </Card>
     
      <div className="flex items-center justify-between mt-4">
        <h1 className="text-base sm:text-lg font-semibold">ãƒ•ã‚¡ã‚¤ãƒ«é€šé”ï¼ˆæœ€æ–°ãƒ»é‡è¦ï¼‰</h1>
        <Button variant="outline" size="sm" onClick={()=>setViewMode('all_files')}>ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã‚‹</Button>
      </div>
     
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        {primary.map(f => <FileCard key={f.id} f={f} />)}
      </div>

      <Modal open={aiOpen} title={aiTarget? (('body' in aiTarget) ? aiTarget.title : `${aiTarget.title} ã®AIè¦ç´„`) : ''} onClose={()=>setAiOpen(false)}>
        {aiTarget && ('body' in aiTarget ? <div className="whitespace-pre-line">{aiTarget.body}</div> : <div className="space-y-2"><p>ï¼ˆãƒ€ãƒŸãƒ¼AIè¦ç´„ï¼‰</p><p>1. é‡è¦ãƒã‚¤ãƒ³ãƒˆã¯ã€Œãƒªãƒ”ã‚¸ãƒ¥ã‚¢EXã€ã§ã™ã€‚</p><p>2. ç¾å ´ã§ã¯ã€Œæ•æ„Ÿè‚Œã®ãŠå®¢æ§˜ã€ã¸ã®å£°ã‹ã‘ã‚’å¾¹åº•ã—ã¦ãã ã•ã„ã€‚</p><p>3. æ³¨æ„äº‹é …ã¯ã€Œæ—¢å­˜å“ã¨ã®ä½µç”¨ã¯éæ¨å¥¨ã€ã§ã™ã€‚</p></div>)}
      </Modal>
    </div>
  );
}


// =================== RelationshipDashboard (ãƒ©ãƒ™ãƒ«ä¿®æ­£) ===================
type WeatherStatus = 'good' | 'cloudy' | 'bad';
interface KpiCard {
  k: string;
  v: number;
  sub: string;
  status: WeatherStatus;
}
interface Risk {
  name: string;
  why: string;
  action: string;
}
interface Bottleneck {
  team: string;
  response: number;
  resolution: number;
  color: string;
}

function RelationshipDashboard(){
 
  const WeatherIcon = ({ status }: { status: WeatherStatus }) => {
    if (status === 'good') return <CheckCircleIcon className="w-5 h-5 text-green-500"/>; // æ™´ã‚Œ
    if (status === 'cloudy') return <ExclamationCircleIcon className="w-5 h-5 text-amber-500"/>; // ãã‚‚ã‚Š
    if (status === 'bad') return <ExclamationCircleIcon className="w-5 h-5 text-rose-500"/>; // é›¨
    return null;
  };

  const cards: KpiCard[] = [
    {k:'Flow (æµã‚Œ)',v:74,sub:'æ»ç•™: Båº—ãƒ»å¤œé–“', status: 'cloudy'},
    {k:'Tone (æ¸©åº¦)',v:68,sub:'ãƒã‚¬æ¯”ç‡â†‘ï¼ˆCåº—ï¼‰', status: 'bad'},
    {k:'Rhythm (ç¶™ç¶š)',v:72,sub:'å¿œç­”å‘¨æœŸã®ä¹±ã‚Œ', status: 'cloudy'},
    {k:'Voice (å£°)',v:81,sub:'åæ˜ ç‡ 63%', status: 'good'},
    {k:'Trust (ä¿¡é ¼)',v:76,sub:'å‰é€± +2', status: 'good'},
  ];

  const summaryPoints: string[] = [
    "ã€Œå±±å£ã•ã‚“ã€ã€Œä½è—¤ã•ã‚“ã€ã®å¿œç­”é…å»¶ï¼ˆRhythmã®è©°ã¾ã‚Šï¼‰ãŒé¡•è‘—ã§ã™ã€‚",
    "å…¨åº—çš„ã«ã€Œæ”¹å–„ææ¡ˆï¼ˆVoiceï¼‰ã€ã®åæ˜ ç‡ãŒä½ä¸‹å‚¾å‘ã«ã‚ã‚Šã¾ã™ï¼ˆå¹³å‡63%ï¼‰ã€‚",
    "ã€Œå±±å£ã•ã‚“ã€ã€Œä½è—¤ã•ã‚“ã€ã«æ¥­å‹™è² è·é›†ä¸­ã¨ãƒã‚¬ãƒ†ã‚£ãƒ–æŠ•ç¨¿ã®å…†å€™ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚"
  ];
 
  const risks: Risk[] = [
    {name:'å±±å£', why:'Voiceæ¸›ï¼‹ãƒã‚¬é«˜ï¼‹æ¬ å‹¤2', action:'å¤œå‹¤å¾Œã®15åˆ†1on1ã§ã€Œæœ€è¿‘ã®å›°ã‚Šã”ã¨ã€ç¢ºèªã€‚åœŸæ›œæ˜¼å¸¯ã®å¿œæ´1æ è¿½åŠ ã‚’æ¤œè¨ã€‚'},
    {name:'ä½è—¤', why:'åæ˜ å¾…ã¡7ä»¶/14æ—¥', action:'ã€Œæœªåæ˜ ã®å…·ä½“ã€ã‚’æ£šå¸ã—â†’ä»Šæ—¥ä¸­ã«3ä»¶ã ã‘ç€æ‰‹ã§ãã‚‹å°ã‚¿ã‚¹ã‚¯åŒ–ã€‚åº—é•·ãŒ1ä»¶ä»£è¡Œç€æ‰‹ã—å‹¢ã„ã‚’ã¤ã‘ã‚‹ã€‚'},
    {name:'ç”°ä¸­', why:'é€£ç¶šæ·±å¤œï¼‹æŠ•ç¨¿0/10æ—¥', action:'æ¬¡ã‚·ãƒ•ãƒˆã§è»½ä½œæ¥­ã¸ãƒ­ãƒ¼ãƒ†ã€‚æœç¤¼ã§ç§°è³›1ãƒˆãƒ”ãƒƒã‚¯ã‚’ä»˜ä¸ã—ã€Voiceå†é–‹ã®åˆå›³ã‚’ä½œã‚‹ã€‚'},
  ];

  const bottleneckData: Bottleneck[] = [
    { team: 'éˆ´æœ¨', response: 4, resolution: 12, color: 'bg-green-300' },
    { team: 'æœ¨æ‘', response: 6, resolution: 18, color: 'bg-green-200' },
    { team: 'ç”°ä¸­', response: 12, resolution: 36, color: 'bg-amber-300' },
    { team: 'å±±å£', response: 28, resolution: 72, color: 'bg-rose-400' }, // è©°ã¾ã‚Š
    { team: 'ä½è—¤', response: 20, resolution: 48, color: 'bg-amber-400' }, // è©°ã¾ã‚Š
  ];

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      <Card className="bg-gradient-to-br from-indigo-50 to-purple-50 border-indigo-200 shadow-lg">
        <CardHeader>
          <div className="flex items-center gap-2">
            <SparklesIcon className="w-6 h-6 text-indigo-600"/>
            <div className="font-semibold text-lg text-gray-900">AIã‚³ãƒ¼ãƒï¼ˆä»Šé€±ã®å„ªå…ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰</div>
          </div>
          <div className="text-sm text-gray-600">ERMãƒ‡ãƒ¼ã‚¿ã¨å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€çµ„ç¹”èª²é¡Œã¨å€‹åˆ¥ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚</div>
        </CardHeader>
        <CardContent>
          <div className="mb-4 border-b pb-4">
            <div className="text-sm font-semibold text-gray-800 mb-2">â–¼ ã‚µãƒãƒªãƒ¼ï¼ˆå…¨ä½“å‚¾å‘ï¼‰</div>
            <ul className="list-disc list-inside space-y-1 text-sm text-gray-800">
              {summaryPoints.map((point, idx) => (
                <li key={idx}>{point}</li>
              ))}
            </ul>
          </div>

          <div className="text-sm font-semibold text-gray-800 mb-2">â–¼ å„ªå…ˆå¯¾å¿œã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆå€‹åˆ¥ï¼‰</div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {risks.map((r,i)=> (
              <div key={i} className="border rounded-2xl p-4 bg-white shadow-sm">
                <div className="flex items-center gap-2">
                  <ExclamationCircleIcon className="w-5 h-5 text-rose-500"/>
                  <div className="text-lg font-bold">{r.name}</div>
                </div>
                <div className="text-xs text-gray-500 mb-2 ml-7">å…†å€™ï¼š{r.why}</div>
                <div className="text-sm text-gray-800">ææ¡ˆï¼š{r.action}</div>
                <div className="mt-3 flex gap-2 text-xs">
                  <Button size="sm" variant="outline">å£°ã‹ã‘ãƒ†ãƒ³ãƒ—ãƒ¬</Button>
                  <Button size="sm" variant="outline">1on1ã‚’ä½œæˆ</Button>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
        {cards.map(c=> (
          <Card key={c.k}>
            <CardHeader className="pb-2">
              <div className="flex items-center justify-between">
                <div className="text-sm font-semibold text-gray-700">{c.k}</div>
                <WeatherIcon status={c.status} />
              </div>
            </CardHeader>
          <CardContent className="text-center">
              <div className="text-4xl font-extrabold tracking-tight text-indigo-600">{c.v}</div>
              <div className="text-xs text-gray-500 mt-1">{c.sub}</div>
            </CardContent>
          </Card>
        ))}
      </div>

    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <Card>
        <CardHeader><div className="font-semibold text-sm">Voiceåæ˜ ç‡ï¼ˆåº—èˆ—åˆ¥ãƒ»é€±æ¬¡ï¼‰</div></CardHeader>
        <CardContent>
          <div className="h-56 bg-gray-50 border rounded-2xl flex items-end gap-2 p-4">
            {[82,56,61,74,69].map((v,i)=> (<div key={i} className="flex-1 bg-indigo-300 rounded-t" style={{height:`${v}%`}} title={`${v}%`}></div>))}
          </div>
        </CardContent>
      </Card>
     
      <Card>
        <CardHeader><div className="font-semibold text-sm">Trustæˆé•·åº¦ï¼ˆå…¨ç¤¾ãƒ»æœˆæ¬¡ï¼‰</div></CardHeader>
        <CardContent>
          <div className="h-56 bg-gray-50 border rounded-2xl flex items-center justify-center p-4 relative">
            <svg viewBox="0 0 100 50" className="w-full h-full absolute inset-0 p-4">
              <path d="M 0 40 C 20 10, 40 30, 60 20, 80 40, 100 30" fill="none" stroke="#4f46e5" strokeWidth="2"/>
              <circle cx="0" cy="40" r="1.5" fill="#4f46e5" />
              <circle cx="20" cy="10" r="1.5" fill="#4f46e5" />
              <circle cx="40" cy="30" r="1.5" fill="#4f46e5" />
              <circle cx="60" cy="20" r="1.5" fill="#4f46e5" />
              <circle cx="80" cy="40" r="1.5" fill="#4f46e5" />
              <circle cx="100" cy="30" r="1.5" fill="#4f46e5" />
            </svg>
          </div>
        </CardContent>
      </Card>

      <Card> 
        <CardHeader><div className="font-semibold text-sm">Rhythmè©°ã¾ã‚Šãƒãƒƒãƒ—ï¼ˆã‚¹ã‚¿ãƒƒãƒ•åˆ¥ å¹³å‡å¿œç­”æ™‚é–“ï¼‰</div></CardHeader>
        <CardContent>
          <div className="space-y-2">
            <div className="flex text-xs text-gray-500">
              <div className="w-1/3">ã‚¹ã‚¿ãƒƒãƒ•å</div>
              <div className="w-2/3">å¿œç­”æ™‚é–“ï¼ˆhï¼‰ [ 0 ... 24 ... 48 ... 72+ ]</div>
            </div>
            {bottleneckData.map(d => (
              <div key={d.team} className="flex items-center">
                <div className="w-1/3 text-sm font-medium text-gray-700 truncate pr-2">{d.team}</div>
                <div className="w-2/3 flex items-center">
                  <div 
                    className={`h-6 rounded ${d.color} transition-all duration-500`} 
                    style={{ width: `${Math.min(100, (d.response / 72) * 100)}%` }}
                  />
                  <span className="text-xs font-semibold ml-2">{d.response}h</span>
                </div>
              </div>
            ))}
            <div className="flex items-center gap-4 text-xs text-gray-500 pt-2">
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-green-300"/> è‰¯å¥½ (ï½12h)</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-amber-300"/> æ³¨æ„ (ï½24h)</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-rose-400"/> å±é™º (24h+)</span>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
     
      <Card>
        <CardHeader><div className="font-semibold text-sm">å‚è€ƒï¼šäº‹å®Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆé€£æºSaaSï¼‰</div></CardHeader>
        <CardContent className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div className="border p-3 rounded-lg text-center">
    <div className="text-xs text-gray-500">KOT (å‹¤æ€ )</div>
    <div className="text-lg font-semibold">é…åˆ» 3å</div>
  </div>
  <div className="border p-3 rounded-lg text-center">
    <div className="text-xs text-gray-500">KOT (å‹¤æ€ )</div>
    <div className="text-lg font-semibold">å¹³å‡æ®‹æ¥­ 18.5h</div>
  </div>
  <div className="border p-3 rounded-lg text-center">
    <div className="text-xs text-gray-500">ã‚«ã‚ªãƒŠãƒ“ (è©•ä¾¡)</div>
    <div className="text-lg font-semibold">è©•ä¾¡ é€²æ— 64%</div>
  </div>
  <div className="border p-3 rounded-lg text-center">
    <div className="text-xs text-gray-500">ã‚«ã‚ªãƒŠãƒ“ (ã‚¹ã‚­ãƒ«)</div>
    <div className="text-lg font-semibold">æ–°å•†å“ãƒ†ã‚¹ãƒˆ 82ç‚¹</div>
  </div>
        </CardContent>
      </Card>
</div>
  );
}


// =================== Integrations (UIä¿®æ­£) ===================
interface IntegrationItem {
  k: string;
  label: string;
  status: 'linked' | 'unlinked';
  sub: string;
}

function Integrations(){
  const items: IntegrationItem[] = [
    { k:'KOT', label:'KING OF TIME (å‹¤æ€ )', status:'linked', sub:'æœ€çµ‚åŒæœŸ: 2025-11-01 00:05' },
    { k:'KAO', label:'ã‚«ã‚ªãƒŠãƒ“ (ã‚¿ãƒ¬ãƒ³ãƒˆ)', status:'linked', sub:'æœ€çµ‚åŒæœŸ: 2025-10-31 23:00' },
    { k:'SHR', label:'SmartHR (åŠ´å‹™)', status:'unlinked', sub:'å¾“æ¥­å“¡ãƒã‚¹ã‚¿ã®é€£æºã‚’æ¨å¥¨ã—ã¾ã™ã€‚' },
    { k:'KIN', label:'kintone (æ¥­å‹™)', status:'linked', sub:'é€£æºDB: kintone-db-123' },
  ];
  const chip = (s: 'linked' | 'unlinked')=> s==='linked' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-700';
 return (
    <div className="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">
      <div className="md:col-span-2 p-4 bg-white rounded-2xl border">
        <h3 className="font-semibold">ä¸­ç«‹çš„ãªERMãƒãƒ–æˆ¦ç•¥</h3>
        <p className="text-sm text-gray-600">tsumugiã¯ã€æ—¢å­˜ã®HR TechSaaSã¨é€£æºã—ã€å½¼ã‚‰ãŒæŒã¦ãªã„ã€Œé–¢ä¿‚æ€§ãƒ‡ãƒ¼ã‚¿ã€ã‚’æ›ã‘åˆã‚ã›ã‚‹ã“ã¨ã§ä¾¡å€¤ã‚’ç”Ÿã¿ã¾ã™ã€‚</p>
  </div>
      {items.map(it => (
        <Card key={it.k}>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div className="text-base font-semibold">{it.label}</div>
              <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${chip(it.status)}`}>{it.status==='linked'?'é€£æºæ¸ˆã¿':'æœªé€£æº'}</span>
          </div>
          </CardHeader>
          <CardContent>
            <div className="text-sm text-gray-600">{it.sub}</div>
            {it.status === 'unlinked' && <Button size="sm" variant="outline" className="mt-3">é€£æºã™ã‚‹</Button>}
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
